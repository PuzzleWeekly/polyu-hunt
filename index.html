<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PolyU Hunt - Campus Treasure Hunt</title>
    
    <!-- React & ReactDOM from CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- QR Code Generator -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    
    <!-- QR Code Scanner -->
    <script src="https://unpkg.com/html5-qrcode"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            overscroll-behavior-y: none;
        }
        
        .polyu-red {
            color: #A6192E;
        }
        
        .bg-polyu-red {
            background-color: #A6192E;
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        .pop-in {
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .slide-up {
            animation: slideUp 0.4s ease-out forwards;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes popIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes scan {
            0% { top: 0; }
            50% { top: 100%; }
            100% { top: 0; }
        }
        
        .map-container {
            background-color: #f8f8f8;
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect fill="%23f0f0f0" width="100" height="100"/><path d="M10 10 L90 10 L90 90 L10 90 Z" fill="none" stroke="%23ddd" stroke-width="1"/><circle cx="50" cy="50" r="20" fill="%23e5e5e5" opacity="0.3"/></svg>');
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
            position: relative;
            overflow: hidden;
            border-radius: 1rem;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.05);
            min-height: 500px;
        }
        
        .map-pin {
            transform: translate(-50%, -100%);
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: absolute;
            cursor: pointer;
        }
        
        .map-pin:hover {
            transform: translate(-50%, -120%) scale(1.1);
            z-index: 20;
        }
        
        .map-pin.locked {
            filter: grayscale(100%);
            opacity: 0.8;
        }
        
        .pin-label {
            background: rgba(255, 255, 255, 0.95);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 800;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            margin-top: 2px;
            color: #333;
            border: 1px solid #ddd;
        }
        
        .stamp-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid;
            font-size: 24px;
            position: relative;
        }
        
        .stamp-earned {
            border-color: #A6192E;
            color: #A6192E;
            background-color: #fff0f0;
            box-shadow: 0 4px 6px rgba(166, 25, 46, 0.2);
        }
        
        .stamp-locked {
            border-color: #e5e7eb;
            color: #d1d5db;
            background-color: #f9fafb;
        }
        
        .scan-line {
            position: absolute;
            left: 0;
            width: 100%;
            height: 2px;
            background: #A6192E;
            box-shadow: 0 0 4px #A6192E;
            animation: scan 1.5s linear infinite;
        }
        
        .input-field {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            outline: none;
            transition: all 0.2s;
        }
        
        .input-field:focus {
            border-color: #A6192E;
            box-shadow: 0 0 0 3px rgba(166, 25, 46, 0.1);
        }
        
        .label {
            display: block;
            font-size: 0.75rem;
            font-weight: 700;
            color: #374151;
            margin-bottom: 0.25rem;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        
        // ==================== CONFIGURATION ====================
        
        // Choose your backend (comment/uncomment):
        const BACKEND = {
            type: 'firebase', // Options: 'firebase', 'nodejs', 'supabase'
            // OR for Firebase:
            // firebaseConfig: { /* config */ }
        };
        
        // ==================== TRANSLATIONS ====================
        
        const TRANSLATIONS = {
            en: {
                appTitle: "PolyU Hunt",
                welcome: "Welcome to PolyU Hunt",
                subtitle: "Join the campus adventure",
                adminLogin: "Admin Login",
                fullName: "Full Name",
                email: "PolyU Email",
                mode: "Participation Mode",
                local: "Local Campus",
                overseas: "Overseas",
                role: "Role",
                visitor: "Visitor",
                student: "Current Student",
                grad: "Graduate",
                staff: "Staff",
                prog: "Programme",
                gradYear: "Graduation Year",
                startBtn: "Start Hunting",
                adminBtn: "Login as Admin",
                adminMode: "Admin Mode",
                findConquer: "Find & Conquer",
                stamps: "Stamps",
                goToLoc: "Go to location to unlock stamp",
                earnStamp: "Earn the Stamp!",
                scanQr: "Scan QR Code / Enter PIN",
                findCode: "Find the code at the location.",
                scanBtn: "Scan QR Code",
                scanning: "Scanning...",
                enterPin: "Enter 4-Digit PIN",
                go: "Go",
                invalidPin: "Invalid PIN",
                bypass: "Bypass (Debug)",
                challenge: "Challenge",
                memories: "Memories Unlocked!",
                readStories: "Read stories from past students",
                collectClose: "Collect Stamp / Close",
                adminPortal: "Admin Portal",
                totalUsers: "Total Users",
                totalStamps: "Total Stamps Awarded",
                userActivity: "User Activity Record",
                myStamps: "My Stamp Collection",
                collectAll: "Collect all visual stamps!",
                clue: "Clue to find the code",
                incorrect: "Incorrect! Try again next time.",
                alreadyClearedTitle: "Already Cleared",
                alreadyClearedMsg: "You've already collected this stamp!",
                stampCollectedTitle: "STAMP COLLECTED!",
                stampCollectedMsg: "You earned the Stamp!",
                password: "Password",
                login: "Login",
                tutorialTitle: "How to Play",
                tutorialIntro: "Welcome to the PolyU 85th Anniversary Hunt!",
                tutorialLocal: "Local Mode: Visit locations on campus, scan the specific QR code for each location, and answer questions to unlock stamps.",
                tutorialOverseas: "Overseas Mode: Enter the event code to unlock the virtual map and explore from home.",
                tutorialGoal: "Goal: Collect all 10 stamps to win the Grand Prize!",
                tutorialStart: "Got it, let's play!",
                lockedTitle: "Location Locked",
                lockedMsg: "You must clear the other 9 locations before you can challenge the final boss!",
                grandSuccessTitle: "GRAND SUCCESS!",
                grandSuccessMsg: "You have conquered all 10 locations! Thank you for exploring PolyU.",
                qrTab: "QR Codes",
                scanError: "Scanner Error. Try entering PIN.",
                wrongLocation: "Wrong Location! This QR code belongs to",
                giftTitle: "Grand Prize Claim",
                giftAsk: "You have completed the map! Would you like a souvenir gift sent to you?",
                giftYes: "Yes, send it!",
                giftNo: "No, thanks",
                confirmEmail: "Confirm Email",
                shippingAddr: "Mailing Address",
                giftSubmitted: "Request Received! We will contact you soon.",
                submitClaim: "Submit Claim",
                savingData: "Saving data...",
                dataError: "Error saving data. Please try again.",
                loading: "Loading..."
            },
            tc: {
                appTitle: "理工獵奇",
                welcome: "歡迎來到理工獵奇",
                // ... (add other Chinese translations)
            },
            sc: {
                appTitle: "理工猎奇",
                // ... (add other Simplified Chinese translations)
            }
        };
        
        // ==================== LOCATIONS & QUESTIONS ====================
        
        const LOCATIONS = [
            {
                id: "corez",
                name: { en: "Core Z Block Z", tc: "Z棟", sc: "Z棟" },
                lat: 22.3050,
                lng: 114.1780,
                mapX: 15,
                mapY: 20,
                icon: "fa-cube",
                code: "1234",
                hint: { en: "On the pillar near the canteen entrance.", tc: "在食堂入口附近的柱子上。", sc: "在食堂入口附近的柱子上。" }
            },
            {
                id: "corem",
                name: { en: "Core M Li Ka Shing", tc: "M棟", sc: "M棟" },
                lat: 22.3045,
                lng: 114.1785,
                mapX: 25,
                mapY: 45,
                icon: "fa-building",
                code: "1234",
                hint: { en: "Near the nursing labs entrance.", tc: "在護理實驗室入口附近。", sc: "在护理实验室入口附近。" }
            },
            {
                id: "corev",
                name: { en: "Core V JCIT", tc: "V棟", sc: "V棟" },
                lat: 22.3060,
                lng: 114.1790,
                mapX: 85,
                mapY: 15,
                icon: "fa-drafting-compass",
                code: "1234",
                hint: { en: "Next to the escalator on the ground floor.", tc: "在一樓扶梯旁。", sc: "在一楼扶梯旁。" }
            },
            {
                id: "lib",
                name: { en: "Main Library", tc: "圖書館", sc: "图书馆" },
                lat: 22.3043,
                lng: 114.1796,
                mapX: 50,
                mapY: 35,
                icon: "fa-book",
                code: "1234",
                hint: { en: "In the corner of the reading zone in 1F.", tc: "在一樓閱讀區的角落。", sc: "在一楼阅读区的角落。" }
            },
            {
                id: "cores",
                name: { en: "Core S Communal", tc: "S棟", sc: "S棟" },
                lat: 22.3038,
                lng: 114.1805,
                mapX: 50,
                mapY: 55,
                icon: "fa-users",
                code: "1234",
                hint: { en: "On the notice board near the SU office.", tc: "在學生會辦公室附近的佈告欄。", sc: "在学生会办公室附近的布告栏。" }
            },
            {
                id: "coreg",
                name: { en: "Core G Wing On", tc: "G棟", sc: "G棟" },
                lat: 22.3038,
                lng: 114.1810,
                mapX: 60,
                mapY: 55,
                icon: "fa-flask",
                code: "1234",
                hint: { en: "Beside the chemistry lab safety poster.", tc: "在化學實驗室安全海報旁。", sc: "在化学实验室安全海报旁。" }
            },
            {
                id: "coreh",
                name: { en: "Core H Computing", tc: "H棟", sc: "H棟" },
                lat: 22.3035,
                lng: 114.1812,
                mapX: 65,
                mapY: 60,
                icon: "fa-laptop-code",
                code: "1234",
                hint: { en: "On the wall near the podium exit.", tc: "在講台出口附近的牆上。", sc: "在讲台出口附近的墙上。" }
            },
            {
                id: "corey",
                name: { en: "Core Y Lee Shau Kee", tc: "Y棟", sc: "Y棟" },
                lat: 22.3030,
                lng: 114.1815,
                mapX: 75,
                mapY: 70,
                icon: "fa-chalkboard-teacher",
                code: "1234",
                hint: { en: "Near the auditorium ticket counter.", tc: "在禮堂售票處附近。", sc: "在礼堂售票处附近。" }
            },
            {
                id: "coreu",
                name: { en: "Core U Industry Center", tc: "U棟", sc: "U棟" },
                lat: 22.3040,
                lng: 114.1820,
                mapX: 85,
                mapY: 50,
                icon: "fa-tools",
                code: "1234",
                hint: { en: "Next to the 3D printing workshop door.", tc: "在3D打印工作室門旁。", sc: "在3D打印工作室门旁。" }
            },
            {
                id: "corea",
                name: { en: "Core A Chung Sze Yuen", tc: "A棟（終極關卡）", sc: "A棟（终极关卡）" },
                lat: 22.3033,
                lng: 114.1793,
                mapX: 20,
                mapY: 85,
                icon: "fa-university",
                code: "1234",
                hint: { en: "Near the main entrance fountain.", tc: "在主入口噴泉附近。", sc: "在主入口喷泉附近。" }
            }
        ];
        
        const QUESTIONS = {
            lib: {
                text: { en: "How many floors does the Main Library have?", tc: "圖書館有多少層？", sc: "图书馆有多少层？" },
                options: { en: ["4", "5", "6", "7"], tc: ["4", "5", "6", "7"], sc: ["4", "5", "6", "7"] },
                answer: { en: "6", tc: "6", sc: "6" }
            },
            corez: {
                text: { en: "What is Block Z famous for?", tc: "Z棟以什麼聞名？", sc: "Z棟以什么闻名？" },
                options: { en: ["Design", "Food", "Construction", "Gardens"], tc: ["設計", "食物", "建築", "花園"], sc: ["设计", "食物", "建筑", "花园"] },
                answer: { en: "Food", tc: "食物", sc: "食物" }
            },
            corea: {
                text: { en: "What year was PolyU established?", tc: "理工大學在哪一年成立？", sc: "理工大学在哪一年成立？" },
                options: { en: ["1937", "1972", "1994", "2000"], tc: ["1937", "1972", "1994", "2000"], sc: ["1937", "1972", "1994", "2000"] },
                answer: { en: "1937", tc: "1937", sc: "1937" }
            }
        };
        
        const getQuestion = (id, lang) => {
            const q = QUESTIONS[id] || QUESTIONS.lib;
            return {
                text: q.text[lang] || q.text.en,
                options: q.options[lang] || q.options.en,
                answer: q.answer[lang] || q.answer.en
            };
        };
        
        const ALUMNISTORIES = {
            lib: [
                { user: "Sarah Grad 2019", text: { en: "I spent 3 nights straight in the 24h reading room.", tc: "我在24小時閱讀室連續待了3晚。", sc: "我在24小时阅读室连续待了3晚。" } },
                { user: "Jason Grad 2021", text: { en: "The LibCafe mocha kept me alive.", tc: "圖書館咖啡館的摩卡救了我。", sc: "图书馆咖啡馆的摩卡救了我。" } }
            ],
            corea: [
                { user: "Dr. Lee", text: { en: "The red bricks represent our heritage.", tc: "紅磚代表我們的傳統。", sc: "红砖代表我们的传统。" } },
                { user: "Alumni 85", text: { en: "Taking graduation photos at the fountain is a must.", tc: "在噴泉旁拍畢業照是必須的。", sc: "在喷泉旁拍毕业照是必须的。" } }
            ]
        };
        
        const getStories = (locId, lang) => {
            const stories = ALUMNISTORIES[locId] || ALUMNISTORIES.lib;
            return stories.map(s => ({
                user: s.user,
                text: s.text[lang] || s.text.en
            }));
        };
        
        // ==================== DATABASE UTILITIES ====================
        
       // DATABASE UTILITIES – Firebase version
        const db = window.dbUtil;

        
        // ==================== COMPONENTS ====================
        
        const LanguageSwitcher = ({ lang, setLang, light = false }) => {
            return (
                <div className={`flex rounded-lg overflow-hidden border ${light ? 'border-white/30' : 'border-gray-300'}`}>
                    {["en", "tc", "sc"].map(l => (
                        <button
                            key={l}
                            onClick={() => setLang(l)}
                            className={`px-3 py-1 text-xs font-bold transition-colors ${
                                lang === l
                                    ? light
                                        ? "bg-white text-A6192E"
                                        : "bg-A6192E text-white"
                                    : light
                                    ? "bg-transparent text-white hover:bg-white/10"
                                    : "bg-white text-gray-500 hover:bg-gray-100"
                            }`}
                        >
                            {l.toUpperCase()}
                        </button>
                    ))}
                </div>
            );
        };
        
        const GiftClaimModal = ({ user, onClose, lang }) => {
            const [step, setStep] = useState(1);
            const [formData, setFormData] = useState({ email: user.email, address: "" });
            const [saving, setSaving] = useState(false);
            const t = TRANSLATIONS[lang];
            
            const handleSubmit = async () => {
                setSaving(true);
                try {
                    await db.saveUser({ ...user, giftRequest: formData });
                    setStep(3);
                } catch (error) {
                    alert(t.dataError);
                } finally {
                    setSaving(false);
                }
            };
            
            return (
                <div className="fixed inset-0 z-80 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 fade-in">
                    <div className="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm text-center pop-in border-t-8 border-A6192E">
                        {step === 1 && (
                            <>
                                <div className="w-16 h-16 rounded-full bg-yellow-100 text-yellow-600 flex items-center justify-center text-3xl mx-auto mb-4">
                                    <i className="fa fa-gift"></i>
                                </div>
                                <h3 className="text-xl font-bold text-gray-800 mb-2">{t.giftTitle}</h3>
                                <p className="text-gray-600 mb-6">{t.giftAsk}</p>
                                <div className="flex flex-col gap-3">
                                    <button
                                        onClick={() => setStep(2)}
                                        className="w-full bg-A6192E text-white py-3 rounded-xl font-bold shadow-lg hover:bg-red-800 transition"
                                    >
                                        {t.giftYes}
                                    </button>
                                    <button
                                        onClick={onClose}
                                        className="w-full bg-gray-100 text-gray-500 py-3 rounded-xl font-bold hover:bg-gray-200 transition"
                                    >
                                        {t.giftNo}
                                    </button>
                                </div>
                            </>
                        )}
                        {step === 2 && (
                            <>
                                <h3 className="text-lg font-bold text-gray-800 mb-4">{t.giftTitle}</h3>
                                <div className="text-left space-y-3 mb-6">
                                    <div>
                                        <label className="text-xs font-bold text-gray-500 block mb-1">{t.confirmEmail}</label>
                                        <input
                                            type="email"
                                            className="w-full p-2 border rounded bg-gray-50"
                                            value={formData.email}
                                            onChange={(e) => setFormData({ ...formData, email: e.target.value })}
                                        />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-gray-500 block mb-1">{t.shippingAddr}</label>
                                        <textarea
                                            className="w-full p-2 border rounded"
                                            rows="3"
                                            value={formData.address}
                                            onChange={(e) => setFormData({ ...formData, address: e.target.value })}
                                        ></textarea>
                                    </div>
                                </div>
                                <button
                                    onClick={handleSubmit}
                                    disabled={!formData.address || saving}
                                    className="w-full bg-green-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-green-700 transition disabled:opacity-50"
                                >
                                    {saving ? t.savingData : t.submitClaim}
                                </button>
                            </>
                        )}
                        {step === 3 && (
                            <>
                                <div className="w-16 h-16 rounded-full bg-green-100 text-green-600 flex items-center justify-center text-3xl mx-auto mb-4">
                                    <i className="fa fa-check"></i>
                                </div>
                                <h3 className="text-xl font-bold text-gray-800 mb-2">Success!</h3>
                                <p className="text-gray-600 mb-6">{t.giftSubmitted}</p>
                                <button
                                    onClick={onClose}
                                    className="w-full bg-gray-800 text-white py-3 rounded-xl font-bold hover:bg-black transition"
                                >
                                    {t.go}
                                </button>
                            </>
                        )}
                    </div>
                </div>
            );
        };
        
        const NotificationModal = ({ title, message, type = "info", customIcon, onClose, lang }) => {
            const t = TRANSLATIONS[lang];
            return (
                <div className="fixed inset-0 z-60 flex items-center justify-center bg-black/40 backdrop-blur-sm p-4 fade-in">
                    <div className="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm text-center pop-in border-t-4 border-A6192E">
                        <div className="flex justify-center mb-4">
                            {customIcon ? (
                                <div className="stamp-circle stamp-earned w-20 h-20 text-3xl">
                                    <i className={`fa ${customIcon}`}></i>
                                </div>
                            ) : (
                                <div className={`w-16 h-16 rounded-full flex items-center justify-center text-3xl ${
                                    type === "success" ? "bg-green-100 text-green-600" :
                                    type === "error" ? "bg-red-100 text-red-600" :
                                    "bg-blue-100 text-blue-600"
                                }`}>
                                    <i className={`fa ${
                                        type === "success" ? "fa-trophy" :
                                        type === "error" ? "fa-lock" :
                                        "fa-info"
                                    }`}></i>
                                </div>
                            )}
                        </div>
                        <h3 className="text-xl font-bold text-gray-800 mb-2">{title}</h3>
                        <p className="text-gray-600 mb-6">{message}</p>
                        <button
                            onClick={onClose}
                            className="w-full bg-A6192E text-white py-3 rounded-xl font-bold shadow-lg hover:bg-red-800 transition"
                        >
                            {t.go}
                        </button>
                    </div>
                </div>
            );
        };
        
        const Register = ({ onRegister, lang, setLang }) => {
            const [role, setRole] = useState("none");
            const [version, setVersion] = useState("local");
            const [formData, setFormData] = useState({ name: "", email: "", programme: "", gradYear: "" });
            const [showTutorial, setShowTutorial] = useState(true);
            const [saving, setSaving] = useState(false);
            const t = TRANSLATIONS[lang];
            
            const handleSubmit = async (e) => {
                e.preventDefault();
                setSaving(true);
                try {
                    const userData = { ...formData, role, version, stamps: [], createdAt: new Date() };
                    await db.saveUser(userData);
                    onRegister(userData);
                } catch (error) {
                    alert(t.dataError);
                    setSaving(false);
                }
            };
            
            return (
                <div className="min-h-screen flex items-center justify-center p-4 bg-gray-100">
                    {showTutorial && (
                        <div className="fixed inset-0 z-80 flex items-center justify-center bg-black/70 backdrop-blur-sm p-4 fade-in">
                            <div className="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-md pop-in">
                                <div className="text-center mb-4">
                                    <div className="w-12 h-12 bg-A6192E rounded-full flex items-center justify-center text-white text-2xl mx-auto mb-3">
                                        <i className="fa fa-question"></i>
                                    </div>
                                    <h2 className="text-2xl font-bold text-gray-800">{t.tutorialTitle}</h2>
                                    <p className="text-sm text-gray-500">{t.tutorialIntro}</p>
                                </div>
                                <div className="space-y-4 text-sm text-gray-700 bg-gray-50 p-4 rounded-xl mb-6">
                                    <p>{t.tutorialLocal}</p>
                                    <p>{t.tutorialOverseas}</p>
                                    <p className="font-bold text-A6192E">{t.tutorialGoal}</p>
                                </div>
                                <button
                                    onClick={() => setShowTutorial(false)}
                                    className="w-full bg-gray-900 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-black transition"
                                >
                                    {t.tutorialStart}
                                </button>
                            </div>
                        </div>
                    )}
                    
                    <div className="bg-white p-6 md:p-8 rounded-2xl shadow-xl w-full max-w-md border-t-8 border-A6192E relative">
                        <div className="absolute top-4 right-4">
                            <LanguageSwitcher lang={lang} setLang={setLang} />
                        </div>
                        
                        <div className="text-center mb-6 pt-6">
                            <div className="bg-A6192E text-white w-16 h-16 rounded-full flex items-center justify-center text-2xl font-bold mx-auto mb-4">
                                P
                            </div>
                            <h1 className="text-2xl font-bold text-gray-800">{t.appTitle}</h1>
                            <p className="text-sm text-gray-500">{t.subtitle}</p>
                        </div>
                        
                        <form onSubmit={handleSubmit} className="space-y-4 fade-in">
                            <input
                                required
                                placeholder={t.fullName}
                                className="input-field"
                                value={formData.name}
                                onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                            />
                            
                            <input
                                required
                                placeholder={t.email}
                                type="email"
                                className="input-field"
                                value={formData.email}
                                onChange={(e) => setFormData({ ...formData, email: e.target.value })}
                            />
                            
                            <div>
                                <label className="label">{t.mode}</label>
                                <div className="grid grid-cols-2 gap-2">
                                    <button
                                        type="button"
                                        onClick={() => setVersion("local")}
                                        className={`p-2 rounded-lg border-2 font-bold text-sm ${
                                            version === "local"
                                                ? "border-A6192E bg-red-50 text-A6192E"
                                                : "border-gray-200 text-gray-400"
                                        }`}
                                    >
                                        <i className="fa fa-map-marker-alt mr-2"></i>{t.local}
                                    </button>
                                    <button
                                        type="button"
                                        onClick={() => setVersion("overseas")}
                                        className={`p-2 rounded-lg border-2 font-bold text-sm ${
                                            version === "overseas"
                                                ? "border-blue-600 bg-blue-50 text-blue-600"
                                                : "border-gray-200 text-gray-400"
                                        }`}
                                    >
                                        <i className="fa fa-globe mr-2"></i>{t.overseas}
                                    </button>
                                </div>
                            </div>
                            
                            <select
                                className="input-field"
                                value={role}
                                onChange={(e) => setRole(e.target.value)}
                            >
                                <option value="none">{t.visitor}</option>
                                <option value="student">{t.student}</option>
                                <option value="grad">{t.grad}</option>
                                <option value="staff">{t.staff}</option>
                            </select>
                            
                            {(role === "student" || role === "grad") && (
                                <input
                                    required
                                    placeholder={t.prog}
                                    className="input-field fade-in"
                                    value={formData.programme}
                                    onChange={(e) => setFormData({ ...formData, programme: e.target.value })}
                                />
                            )}
                            
                            {role === "grad" && (
                                <input
                                    required
                                    placeholder={t.gradYear}
                                    type="number"
                                    className="input-field fade-in"
                                    value={formData.gradYear}
                                    onChange={(e) => setFormData({ ...formData, gradYear: e.target.value })}
                                />
                            )}
                            
                            <button
                                type="submit"
                                disabled={saving}
                                className="w-full text-white py-3 rounded-xl font-bold hover:opacity-90 transition shadow-lg bg-A6192E disabled:opacity-50"
                            >
                                {saving ? t.savingData : t.startBtn}
                            </button>
                        </form>
                    </div>
                </div>
            );
        };
        
        const MapScreen = ({ user, locations, clearedLocations, onOpenStampBook, onSelectLocation, onOpenAdmin, lang, setLang }) => {
            const t = TRANSLATIONS[lang];
            const isLocal = user.version === "local";
            const canAccess10th = !isLocal || clearedLocations.length >= 9;
            
            return (
                <div className="flex flex-col h-screen bg-gray-50">
                    <header className="bg-white shadow-sm p-4 z-10 flex justify-between items-center flex-shrink-0">
                        <div className="flex items-center space-x-2">
                            <div className="w-8 h-8 bg-A6192E rounded-full flex items-center justify-center text-white font-bold text-sm">
                                P
                            </div>
                            <div>
                                <h1 className="font-bold text-gray-800 leading-tight">{t.appTitle}</h1>
                                <div className="flex items-center gap-2">
                                    <p className="text-10px text-gray-500">
                                        {user.role === "admin" ? t.adminMode : t.findConquer}
                                    </p>
                                    {user.version === "overseas" && (
                                        <span className="text-10px bg-blue-100 text-blue-700 px-1 rounded font-bold">
                                            {t.overseas}
                                        </span>
                                    )}
                                    {user.version === "local" && (
                                        <span className="text-10px bg-red-100 text-red-700 px-1 rounded font-bold">
                                            {t.local}
                                        </span>
                                    )}
                                </div>
                            </div>
                        </div>
                        <div className="flex items-center gap-3">
                            <LanguageSwitcher lang={lang} setLang={setLang} />
                            <button
                                onClick={onOpenStampBook}
                                className="bg-yellow-100 text-yellow-800 px-3 py-1.5 rounded-full text-xs font-bold flex items-center gap-2 hover:bg-yellow-200 transition shadow-sm border border-yellow-200"
                            >
                                <i className="fa fa-book-open"></i>
                                <span>{clearedLocations.length}{t.stamps}</span>
                            </button>
                        </div>
                    </header>
                    
                    <main className="flex-grow relative overflow-hidden p-4 md:p-8">
                        <div className="w-full h-full max-w-5xl mx-auto map-container shadow-inner relative border border-gray-300">
                            {locations.map(loc => {
                                const isCleared = clearedLocations.includes(loc.id);
                                const is10th = loc.id === "corea";
                                const isLocked = is10th && !canAccess10th;
                                
                                return (
                                    <div
                                        key={loc.id}
                                        className={`absolute cursor-pointer flex flex-col items-center group map-pin ${
                                            isCleared ? "opacity-75" : ""
                                        } ${isLocked ? "locked grayscale" : ""}`}
                                        style={{ left: `${loc.mapX}%`, top: `${loc.mapY}%` }}
                                        onClick={() => onSelectLocation(loc, isLocked)}
                                    >
                                        <div className={`w-8 h-8 md:w-10 md:h-10 rounded-full border-2 flex items-center justify-center shadow-lg transition-transform group-hover:scale-110 ${
                                            isCleared
                                                ? "bg-green-500 border-white text-white"
                                                : isLocked
                                                ? "bg-gray-400 border-white text-white"
                                                : "bg-A6192E border-white text-white"
                                        }`}>
                                            <i className={`fa ${isCleared ? "fa-check" : isLocked ? "fa-lock" : loc.icon} text-sm`}></i>
                                        </div>
                                        <div className="pin-label">{loc.name[lang]}</div>
                                    </div>
                                );
                            })}
                        </div>
                    </main>
                    
                    <div className="bg-white border-t p-4 flex-shrink-0 safe-area-bottom">
                        <div className="max-w-md mx-auto grid grid-cols-2 gap-4">
                            {user.role === "admin" && (
                                <button
                                    onClick={onOpenAdmin}
                                    className="bg-blue-800 text-white py-3 rounded-lg font-bold text-sm shadow hover:bg-blue-700 relative col-span-2"
                                >
                                    <i className="fa fa-chart-bar mr-2"></i>{t.adminPortal}
                                </button>
                            )}
                            <div className="text-xs text-center text-gray-400 col-span-2 flex items-center justify-center italic">
                                {t.goToLoc}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
        const LocationModal = ({ location, onClose, onStartQuiz, lang, onScanError }) => {
            const [scanStatus, setScanStatus] = useState("idle");
            const [inputCode, setInputCode] = useState("");
            const [codeError, setCodeError] = useState(false);
            const t = TRANSLATIONS[lang];
            const scannerRef = useRef(null);
            
            useEffect(() => {
                return () => {
                    if (scannerRef.current) {
                        scannerRef.current.clear();
                    }
                };
            }, []);
            
            const onScanSuccess = (decodedText) => {
                const expectedCode = "POLYUHUNT-" + location.id;
                if (decodedText === expectedCode) {
                    if (scannerRef.current) scannerRef.current.clear();
                    setScanStatus("success");
                    setTimeout(onStartQuiz, 1000);
                } else if (decodedText.startsWith("POLYUHUNT-")) {
                    alert(t.wrongLocation + " " + decodedText.split("-")[1]);
                } else {
                    alert("Invalid QR Code");
                }
            };
            
            const onScanFailure = (error) => {
                console.warn("Code scan error:", error);
            };
            
            const startScanner = () => {
                setScanStatus("scanning");
                const html5QrcodeScanner = new Html5QrcodeScanner(
                    "reader",
                    { fps: 10, qrbox: { width: 250, height: 250 } },
                    false
                );
                html5QrcodeScanner.render(onScanSuccess, onScanFailure);
                scannerRef.current = html5QrcodeScanner;
            };
            
            const handleCodeVerify = () => {
                if (inputCode.trim() === location.code) {
                    onStartQuiz();
                } else {
                    setCodeError(true);
                }
            };
            
            return (
                <div className="fixed inset-0 z-50 flex items-end md:items-center justify-center bg-black/50 backdrop-blur-sm p-0 md:p-4 fade-in">
                    <div className="bg-white w-full md:max-w-md rounded-t-2xl md:rounded-2xl p-6 shadow-2xl slide-up max-h-90vh overflow-y-auto">
                        <div className="flex justify-between items-start mb-6">
                            <div>
                                <h2 className="text-2xl font-bold text-gray-800">{location.name[lang]}</h2>
                                <p className="text-sm text-gray-500 font-bold text-A6192E">{t.earnStamp}</p>
                            </div>
                            <button
                                onClick={onClose}
                                className="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200"
                            >
                                <i className="fa fa-times text-gray-600"></i>
                            </button>
                        </div>
                        
                        <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-r-lg mb-6">
                            <div className="flex items-start">
                                <i className="fa fa-lightbulb text-yellow-500 mt-1 mr-3"></i>
                                <div>
                                    <h4 className="font-bold text-yellow-800 text-sm">{t.clue}</h4>
                                    <p className="text-sm text-yellow-700 italic">{location.hint[lang]}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div className="mb-4">
                            {scanStatus === "idle" && (
                                <button
                                    onClick={startScanner}
                                    className="w-full py-4 rounded-xl font-bold shadow-lg transition flex items-center justify-center gap-3 bg-gray-900 text-white hover:bg-black"
                                >
                                    <i className="fa fa-qrcode text-xl"></i>
                                    <span>{t.scanBtn}</span>
                                </button>
                            )}
                            {scanStatus === "scanning" && (
                                <div className="rounded-xl overflow-hidden bg-black">
                                    <div id="reader" style={{ width: "100%" }}></div>
                                </div>
                            )}
                            {scanStatus === "success" && (
                                <div className="w-full py-4 rounded-xl font-bold shadow-lg flex items-center justify-center gap-3 bg-green-600 text-white">
                                    <i className="fa fa-check-circle text-xl"></i>
                                    <span>{t.verified}</span>
                                </div>
                            )}
                        </div>
                        
                        <div className="flex items-center justify-center my-4">
                            <div className="flex-grow h-px bg-gray-200"></div>
                            <span className="px-3 text-xs font-bold text-gray-400 uppercase">{t.or}</span>
                            <div className="flex-grow h-px bg-gray-200"></div>
                        </div>
                        
                        <div className="bg-white border rounded-xl p-4 mb-4">
                            <h3 className="font-bold text-gray-700 mb-2 text-sm">{t.enterPin}</h3>
                            <div className="flex gap-2">
                                <input
                                    type="text"
                                    className="input-field py-2 text-center tracking-widest font-bold uppercase"
                                    placeholder="PIN"
                                    maxLength="4"
                                    value={inputCode}
                                    onChange={(e) => {
                                        setInputCode(e.target.value);
                                        setCodeError(false);
                                    }}
                                />
                                <button
                                    onClick={handleCodeVerify}
                                    className="bg-gray-100 text-gray-800 border border-gray-300 px-4 rounded-lg font-bold hover:bg-gray-200 transition"
                                >
                                    {t.go}
                                </button>
                            </div>
                            {codeError && (
                                <div className="text-red-500 text-xs mt-2 font-bold">
                                    <i className="fa fa-times-circle"></i> {t.invalidPin}
                                </div>
                            )}
                        </div>
                        
                        <div className="border-t pt-4 text-center">
                            <button
                                onClick={() => {
                                    setInputCode("1234");
                                    onStartQuiz();
                                }}
                                className="text-xs text-gray-400 hover:text-gray-600"
                            >
                                {t.bypass}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };
        
        const QuizScreen = ({ location, question, onBack, onComplete, onAnswerLog, lang }) => {
            const [view, setView] = useState("question");
            const [feedback, setFeedback] = useState(null);
            const [userAnswer, setUserAnswer] = useState(null);
            const t = TRANSLATIONS[lang];
            const stories = getStories(location.id, lang);
            
            const handleAnswer = (opt) => {
                if (userAnswer) return;
                setUserAnswer(opt);
                const isCorrect = opt === question.answer;
                setFeedback(isCorrect ? "correct" : "wrong");
                onAnswerLog(location.id);
                if (isCorrect) {
                    setTimeout(() => setView("stories"), 1500);
                }
            };
            
            if (view === "question") {
                return (
                    <div className="fixed inset-0 z-50 bg-white flex flex-col h-screen">
                        <div className="p-4 border-b flex items-center justify-between">
                            <button onClick={onBack} className="text-gray-500 p-2">
                                <i className="fa fa-times"></i>
                            </button>
                            <div className="font-bold text-gray-800">{t.challenge}</div>
                            <div className="w-8"></div>
                        </div>
                        
                        <div className="flex-grow overflow-y-auto p-6 max-w-2xl mx-auto w-full">
                            <h3 className="text-xl md:text-2xl font-bold text-gray-900 mb-8 leading-relaxed">
                                {question.text}
                            </h3>
                            <div className="space-y-3">
                                {question.options.map((opt, i) => (
                                    <button
                                        key={i}
                                        onClick={() => handleAnswer(opt)}
                                        className={`w-full p-4 text-left border-2 rounded-xl transition font-medium ${
                                            userAnswer === opt
                                                ? opt === question.answer
                                                    ? "bg-green-100 border-green-500 text-green-700"
                                                    : "bg-red-100 border-red-500 text-red-700"
                                                : "border-gray-100 hover:border-A6192E hover:bg-red-50"
                                        }`}
                                    >
                                        {opt}
                                    </button>
                                ))}
                            </div>
                            {feedback === "wrong" && (
                                <div className="mt-6 p-4 bg-red-50 text-red-600 rounded-xl text-center font-bold fade-in">
                                    {t.incorrect}
                                </div>
                            )}
                        </div>
                    </div>
                );
            }
            
            return (
                <div className="fixed inset-0 z-50 bg-white flex flex-col h-screen fade-in">
                    <div className="bg-A6192E text-white p-8 text-center rounded-b-3xl shadow-lg relative">
                        <div className="text-4xl mb-2">🎉</div>
                        <h2 className="text-2xl font-bold">{t.memories}</h2>
                        <p className="opacity-90 text-sm">{t.readStories}</p>
                    </div>
                    
                    <div className="flex-grow overflow-y-auto p-6 max-w-2xl mx-auto w-full -mt-4">
                        {stories.map((story, i) => (
                            <div
                                key={i}
                                className="bg-white p-6 rounded-xl shadow-md border border-gray-100 mb-4 slide-up"
                                style={{ animationDelay: `${i * 0.1}s` }}
                            >
                                <p className="text-gray-600 italic mb-3">{story.text}</p>
                                <div className="text-right">
                                    <span className="text-xs font-bold text-A6192E bg-red-50 px-2 py-1 rounded">
                                        <i className="fa fa-user mr-1"></i>{story.user}
                                    </span>
                                </div>
                            </div>
                        ))}
                    </div>
                    
                    <div className="p-4 bg-white border-t safe-area-bottom">
                        <button
                            onClick={() => onComplete(true)}
                            className="w-full bg-gray-900 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-black max-w-md mx-auto block"
                        >
                            {t.collectClose}
                        </button>
                    </div>
                </div>
            );
        };
        
        const StampBook = ({ locations, clearedLocations, onClose, lang }) => {
            const t = TRANSLATIONS[lang];
            const earnedCount = clearedLocations.length;
            const total = locations.length;
            const progress = (earnedCount / total) * 100;
            
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 fade-in">
                    <div className="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-lg relative max-h-90vh overflow-y-auto">
                        <button
                            onClick={onClose}
                            className="absolute top-4 right-4 text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100"
                        >
                            <i className="fa fa-times text-xl"></i>
                        </button>
                        
                        <div className="text-center mb-6">
                            <h2 className="text-2xl font-bold text-A6192E mb-1">{t.myStamps}</h2>
                            <p className="text-gray-500 text-sm">{t.collectAll}</p>
                        </div>
                        
                        <div className="mt-4 flex items-center gap-2 max-w-xs mx-auto mb-6">
                            <div className="flex-grow h-2 bg-gray-200 rounded-full overflow-hidden">
                                <div
                                    className="h-full bg-A6192E transition-all duration-500"
                                    style={{ width: `${progress}%` }}
                                ></div>
                            </div>
                            <span className="text-xs font-bold text-gray-600">
                                {earnedCount}/{total}
                            </span>
                        </div>
                        
                        <div className="grid grid-cols-3 gap-4">
                            {locations.map(loc => {
                                const isEarned = clearedLocations.includes(loc.id);
                                return (
                                    <div
                                        key={loc.id}
                                        className={`flex flex-col items-center p-3 rounded-xl border-2 transition-all ${
                                            isEarned
                                                ? "border-A6192E bg-red-50"
                                                : "border-gray-200 bg-gray-50"
                                        }`}
                                    >
                                        <div className="stamp-circle mb-2" style={{
                                            borderColor: isEarned ? "#A6192E" : "#e5e7eb",
                                            color: isEarned ? "#A6192E" : "#d1d5db",
                                            backgroundColor: isEarned ? "#fff0f0" : "#f9fafb"
                                        }}>
                                            <i className={`fa ${loc.icon}`}></i>
                                            {isEarned && (
                                                <div className="absolute -bottom-1 -right-1 w-6 h-6 bg-green-500 text-white text-xs rounded-full flex items-center justify-center border-2 border-white">
                                                    <i className="fa fa-check"></i>
                                                </div>
                                            )}
                                        </div>
                                        <span className={`text-10px font-bold text-center leading-tight ${
                                            isEarned ? "text-A6192E" : "text-gray-400"
                                        }`}>
                                            {loc.name[lang]}
                                        </span>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };
        
        const AdminDashboard = ({ onBack, stats, allUsers, locations, lang }) => {
            const [tab, setTab] = useState("qr");
            const t = TRANSLATIONS[lang];
            
            return (
                <div className="fixed inset-0 z-50 bg-gray-100 flex flex-col h-screen overflow-y-auto">
                    <div className="bg-white p-4 shadow-sm flex items-center justify-between sticky top-0 z-10">
                        <div className="flex items-center">
                            <button onClick={onBack} className="text-gray-500 mr-4">
                                <i className="fa fa-arrow-left"></i>
                            </button>
                            <h2 className="font-bold text-xl">{t.adminPortal}</h2>
                        </div>
                    </div>
                    
                    <div className="flex bg-gray-100 rounded p-1 mx-4 mt-4">
                        <button
                            onClick={() => setTab("qr")}
                            className={`px-4 py-1 rounded text-sm font-bold ${
                                tab === "qr"
                                    ? "bg-white shadow text-A6192E"
                                    : "text-gray-500"
                            }`}
                        >
                            {t.qrTab}
                        </button>
                        <button
                            onClick={() => setTab("stats")}
                            className={`px-4 py-1 rounded text-sm font-bold ${
                                tab === "stats"
                                    ? "bg-white shadow text-A6192E"
                                    : "text-gray-500"
                            }`}
                        >
                            Stats
                        </button>
                    </div>
                    
                    <div className="p-4 max-w-4xl mx-auto w-full space-y-4">
                        {tab === "qr" && (
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 fade-in">
                                {LOCATIONS.map(loc => (
                                    <div key={loc.id} className="bg-white p-6 rounded-xl shadow-sm text-center">
                                        <h3 className="font-bold text-lg text-gray-800 mb-2">{loc.name[lang]}</h3>
                                        <div className="flex justify-center my-4">
                                            <canvas ref={(el) => {
                                                if (el) new QRious({ element: el, value: "POLYUHUNT-" + loc.id, size: 200 });
                                            }} />
                                        </div>
                                        <p className="text-xs text-gray-400 font-mono">POLYUHUNT-{loc.id}</p>
                                    </div>
                                ))}
                            </div>
                        )}
                        
                        {tab === "stats" && (
                            <div className="space-y-6 fade-in">
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="bg-white p-4 rounded-xl shadow-sm">
                                        <p className="text-xs text-gray-500 uppercase">{t.totalUsers}</p>
                                        <p className="text-2xl font-bold text-A6192E">{allUsers.length}</p>
                                    </div>
                                    <div className="bg-white p-4 rounded-xl shadow-sm">
                                        <p className="text-xs text-gray-500 uppercase">{t.totalStamps}</p>
                                        <p className="text-2xl font-bold text-A6192E">
                                            {Object.values(stats.userAnswers || {}).reduce((a, b) => a + b, 0)}
                                        </p>
                                    </div>
                                </div>
                                
                                <div className="bg-white rounded-xl shadow-sm overflow-hidden">
                                    <div className="p-4 border-b bg-gray-50 font-bold text-gray-700">
                                        {t.userActivity}
                                    </div>
                                    <table className="w-full text-sm text-left">
                                        <thead className="text-xs text-gray-500 uppercase bg-gray-50 border-b">
                                            <tr>
                                                <th className="px-6 py-3">{t.fullName}</th>
                                                <th className="px-6 py-3">{t.role}</th>
                                                <th className="px-6 py-3">{t.stamps}</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {allUsers.map((u, i) => (
                                                <tr key={i} className="bg-white border-b hover:bg-gray-50">
                                                    <td className="px-6 py-4 font-medium text-gray-900">{u.name}</td>
                                                    <td className="px-6 py-4">{u.role}</td>
                                                    <td className="px-6 py-4 font-bold text-A6192E">
                                                        {(stats.userAnswers?.[u.email] || 0)}
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };
        
        // ==================== MAIN APP ====================
        
        const App = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState("register");
            const [lang, setLang] = useState("en");
            const [activeLoc, setActiveLoc] = useState(null);
            const [modalOpen, setModalOpen] = useState(false);
            const [notification, setNotification] = useState(null);
            const [stampBookOpen, setStampBookOpen] = useState(false);
            const [giftClaimOpen, setGiftClaimOpen] = useState(false);
            const [cleared, setCleared] = useState([]);
            const [allUsers, setAllUsers] = useState([
                { name: "Alice Chan", email: "alice@polyu.edu.hk", role: "student" },
                { name: "Bob Lee", email: "bob@polyu.edu.hk", role: "staff" }
            ]);
            const [stats, setStats] = useState({
                userAnswers: { "alice@polyu.edu.hk": 5, "bob@polyu.edu.hk": 2 }
            });
            
            const t = TRANSLATIONS[lang];
            
            const showNotify = (title, message, type = "info", customIcon = null) => {
                setNotification({ title, message, type, customIcon });
            };
            
            const handleAnswerLog = (locationId) => {
                setStats(prev => ({
                    ...prev,
                    userAnswers: {
                        ...prev.userAnswers,
                        [user.email]: (prev.userAnswers[user.email] || 0) + 1
                    }
                }));
            };
            
            const handleQuizComplete = (success) => {
                if (success) {
                    if (!cleared.includes(activeLoc.id)) {
                        const newCleared = [...cleared, activeLoc.id];
                        setCleared(newCleared);
                        db.updateStamps(user.email, newCleared).catch(err => console.error(err));
                        
                        if (newCleared.length === 10) {
                            if (user.version === "overseas") {
                                setGiftClaimOpen(true);
                            } else {
                                showNotify(t.grandSuccessTitle, t.grandSuccessMsg, "success", "fa-crown");
                            }
                        } else {
                            showNotify(t.stampCollectedTitle, `${t.stampCollectedMsg} ${activeLoc.name[lang]}`, "success", activeLoc.icon);
                        }
                    } else {
                        showNotify(t.alreadyClearedTitle, t.alreadyClearedMsg, "info", activeLoc.icon);
                    }
                }
                setActiveLoc(null);
                setView("map");
            };
            
            const handleSelectLocation = (loc, isLocked) => {
                if (isLocked) {
                    showNotify(t.lockedTitle, t.lockedMsg, "error");
                    return;
                }
                setActiveLoc(loc);
                setModalOpen(true);
            };
            
            const handleRegister = (userData) => {
                setUser(userData);
                setAllUsers([...allUsers, userData]);
                setView("map");
            };
            
            if (!user) {
                return <Register onRegister={handleRegister} lang={lang} setLang={setLang} />;
            }
            
            return (
                <div className="text-gray-800">
                    {notification && (
                        <NotificationModal
                            title={notification.title}
                            message={notification.message}
                            type={notification.type}
                            customIcon={notification.customIcon}
                            onClose={() => setNotification(null)}
                            lang={lang}
                        />
                    )}
                    
                    {stampBookOpen && (
                        <StampBook
                            locations={LOCATIONS}
                            clearedLocations={cleared}
                            onClose={() => setStampBookOpen(false)}
                            lang={lang}
                        />
                    )}
                    
                    {giftClaimOpen && (
                        <GiftClaimModal
                            user={user}
                            onClose={() => setGiftClaimOpen(false)}
                            lang={lang}
                        />
                    )}
                    
                    {view === "map" && (
                        <>
                            <MapScreen
                                user={user}
                                locations={LOCATIONS}
                                clearedLocations={cleared}
                                onOpenStampBook={() => setStampBookOpen(true)}
                                onSelectLocation={handleSelectLocation}
                                onOpenAdmin={() => setView("admin")}
                                lang={lang}
                                setLang={setLang}
                            />
                            
                            {modalOpen && activeLoc && (
                                <LocationModal
                                    location={activeLoc}
                                    onClose={() => setModalOpen(false)}
                                    onStartQuiz={() => {
                                        setModalOpen(false);
                                        setView("quiz");
                                    }}
                                    lang={lang}
                                />
                            )}
                        </>
                    )}
                    
                    {view === "quiz" && activeLoc && (
                        <QuizScreen
                            location={activeLoc}
                            question={getQuestion(activeLoc.id, lang)}
                            onBack={() => setView("map")}
                            onComplete={handleQuizComplete}
                            onAnswerLog={handleAnswerLog}
                            lang={lang}
                        />
                    )}
                    
                    {view === "admin" && (
                        <AdminDashboard
                            onBack={() => setView("map")}
                            stats={stats}
                            allUsers={allUsers}
                            locations={LOCATIONS}
                            lang={lang}
                        />
                    )}
                </div>
            );
        };
        
        const root = ReactDOM.createRoot(document.getElementById("root"));
        root.render(<App />);
</script>
    
    <script type="module" src="firebase-backend.js"></script>

</body>

</html>


