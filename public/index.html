<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PolyU Hunt</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- QR Code Generator (QRious) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

    <!-- QR Code Scanner (html5-qrcode) -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <!-- Chart.js for Admin Dashboard -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- FIREBASE SETUP -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDUCHks8Q3smU6dMruN-otcpEWCamOOWPA",
            authDomain: "polyu-hunt.firebaseapp.com",
            projectId: "polyu-hunt",
            storageBucket: "polyu-hunt.firebasestorage.app",
            messagingSenderId: "958809195745",
            appId: "1:958809195745:web:1be0bc46e7cdf88a6e63a0",
            measurementId: "G-S3HQ8XDE59"
        };

        // Initialize Firebase
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase Init Error:", e);
        }
        
        const appId = "polyu_hunt_game_v1";

        // Expose to window for React to use
        window.FB = {
            auth,
            db,
            appId,
            signInAnonymously,
            onAuthStateChanged,
            collection,
            doc,
            setDoc,
            getDoc,
            onSnapshot,
            updateDoc,
            arrayUnion
        };
        
        console.log("Firebase Initialized");
    </script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior-y: none;
            /* Background Image Setup */
            background-color: #f3f4f6; /* Fallback */
            background-image: linear-gradient(rgba(255, 255, 255, 0.85), rgba(255, 255, 255, 0.85)), url('https://upload.wikimedia.org/wikipedia/commons/c/c6/Hong_Kong_Polytechnic_University_Main_Campus_202206.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        .polyu-red { color: #A6192E; }
        .bg-polyu-red { background-color: #A6192E; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        .pop-in { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .slide-up { animation: slideUp 0.4s ease-out forwards; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popIn { 
            from { opacity: 0; transform: scale(0.9); } 
            to { opacity: 1; transform: scale(1); } 
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes scan {
            0% { top: 0; }
            50% { top: 100%; }
            100% { top: 0; }
        }
        
        .map-container {
            background-color: #f8f8f8;
            background-image: url('CampusMap.pdf.jpg'); 
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            position: relative;
            overflow: hidden;
            border-radius: 1rem;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.05);
            min-height: 500px; 
        }
        
        .map-pin {
            transform: translate(-50%, -100%);
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: absolute;
        }
        .map-pin:hover {
            transform: translate(-50%, -120%) scale(1.1);
            z-index: 20;
        }
        .map-pin.locked {
            filter: grayscale(100%);
            opacity: 0.8;
        }
        
        .pin-label {
            background: rgba(255, 255, 255, 0.95);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 800;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            margin-top: 2px;
            color: #333;
            border: 1px solid #ddd;
        }

        .stamp-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid;
            font-size: 24px;
            position: relative;
        }
        .stamp-earned {
            border-color: #A6192E;
            color: #A6192E;
            background-color: #fff0f0;
            box-shadow: 0 4px 6px rgba(166, 25, 46, 0.2);
        }
        .stamp-locked {
            border-color: #e5e7eb;
            color: #d1d5db;
            background-color: #f9fafb;
        }
        
        .scan-line {
            position: absolute;
            left: 0;
            width: 100%;
            height: 2px;
            background: #A6192E;
            box-shadow: 0 0 4px #A6192E;
            animation: scan 1.5s linear infinite;
        }

        /* Chart Container Constraint */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Localization Database ---
        const TRANSLATIONS = {
            en: {
                appTitle: "PolyU Hunt",
                welcome: "Welcome to PolyU Hunt",
                subtitle: "Join the campus adventure",
                adminLogin: "Admin Login",
                fullName: "Full Name",
                email: "PolyU Email",
                mode: "Participation Mode",
                local: "Local (Campus)",
                overseas: "Overseas",
                role: "Role",
                visitor: "Visitor",
                student: "Current Student",
                grad: "Graduate",
                staff: "Staff",
                prog: "Programme",
                gradYear: "Graduation Year",
                startBtn: "Start Hunting",
                adminBtn: "Login as Admin",
                adminMode: "Admin Mode",
                findConquer: "Find & Conquer",
                stamps: "Stamps",
                goToLoc: "Go to location to unlock stamp",
                earnStamp: "Earn the Stamp!",
                gpsVerify: "GPS Verification",
                checkGps: "Check GPS",
                locating: "Locating...",
                verified: "Verified!",
                tooFar: "Too far!",
                gpsError: "GPS Error",
                or: "OR",
                scanQr: "Scan QR Code / Enter PIN",
                findCode: "Find the code at the location.",
                scanBtn: "Scan QR Code",
                scanning: "Scanning...",
                enterPin: "Enter 4-Digit PIN",
                go: "Go",
                invalidPin: "Invalid PIN",
                bypass: "Bypass (Debug)",
                challenge: "Challenge",
                memories: "Memories Unlocked!",
                readStories: "Read stories from past students",
                collectClose: "Collect Stamp & Close",
                adminPortal: "Admin Portal",
                totalUsers: "Total Users",
                totalStamps: "Total Stamps Awarded",
                userActivity: "User Activity Record",
                overseasActivation: "Overseas Activation",
                enterEventCode: "Enter the Global Event Code to unlock the entire campus map from your location.",
                unlockCampus: "Unlock Campus",
                invalidEventCode: "Invalid Event Code. Try 8888.",
                myStamps: "My Stamp Collection",
                collectAll: "Collect all visual stamps!",
                clue: "Clue to find the code:",
                incorrect: "Incorrect! Try again next time.",
                alreadyClearedTitle: "Already Cleared",
                alreadyClearedMsg: "You've already collected this stamp!",
                stampCollectedTitle: "STAMP COLLECTED!",
                stampCollectedMsg: "You earned the Stamp!",
                password: "Password",
                login: "Login",
                tutorialTitle: "How to Play",
                tutorialIntro: "Welcome to the PolyU 85th Anniversary Hunt!",
                tutorialLocal: "ðŸ“ Local Mode: Visit locations on campus, scan the specific QR code for each location, and answer questions to unlock stamps.",
                tutorialOverseas: "ðŸŒ Overseas Mode: Enter the event code to unlock the virtual map and explore from home.",
                tutorialGoal: "ðŸ† Goal: Collect all 10 stamps to win the Grand Prize!",
                tutorialStart: "Got it, let's play!",
                lockedTitle: "Location Locked",
                lockedMsg: "You must clear the other 9 locations before you can challenge the final boss!",
                grandSuccessTitle: "GRAND SUCCESS!",
                grandSuccessMsg: "You have conquered all 10 locations! Thank you for exploring PolyU.",
                qrTab: "QR Codes",
                scanError: "Scanner Error. Try entering PIN.",
                wrongLocation: "Wrong Location! This QR code belongs to",
                giftTitle: "Grand Prize Claim",
                giftAsk: "You have completed the map! Would you like a souvenir gift sent to you?",
                giftYes: "Yes, send it!",
                giftNo: "No, thanks",
                confirmEmail: "Confirm Email",
                shippingAddr: "Mailing Address",
                giftSubmitted: "Request Received! We will contact you soon.",
                submitClaim: "Submit Claim",
                authError: "Authentication Error. Running in Offline Mode.",
                statsTab: "Stats"
            },
            tc: {
                appTitle: "ç†å¤§å°‹å¯¶",
                welcome: "æ­¡è¿Žä¾†åˆ°ç†å¤§å°‹å¯¶",
                subtitle: "åƒèˆ‡æ ¡åœ’æŽ¢ç´¢ä¹‹æ—…",
                adminLogin: "ç®¡ç†å“¡ç™»å…¥",
                fullName: "å…¨å",
                email: "ç†å¤§é›»éƒµ",
                mode: "åƒèˆ‡æ¨¡å¼",
                local: "æœ¬åœ° (æ ¡åœ’)",
                overseas: "æµ·å¤–",
                role: "èº«åˆ†",
                visitor: "è¨ªå®¢",
                student: "åœ¨è®€å­¸ç”Ÿ",
                grad: "ç•¢æ¥­ç”Ÿ",
                staff: "æ•™è·å“¡",
                prog: "èª²ç¨‹",
                gradYear: "ç•¢æ¥­å¹´ä»½",
                startBtn: "é–‹å§‹å°‹å¯¶",
                adminBtn: "ç®¡ç†å“¡ç™»å…¥",
                adminMode: "ç®¡ç†å“¡æ¨¡å¼",
                findConquer: "æŽ¢ç´¢èˆ‡å¾æœ",
                stamps: "å°ç« ",
                goToLoc: "å‰å¾€åœ°é»žè§£éŽ–å°ç« ",
                earnStamp: "è´å–å°ç« ï¼",
                gpsVerify: "GPS å®šä½é©—è­‰",
                checkGps: "æª¢æŸ¥ GPS",
                locating: "å®šä½ä¸­...",
                verified: "é©—è­‰æˆåŠŸï¼",
                tooFar: "è·é›¢å¤ªé ï¼",
                gpsError: "GPS éŒ¯èª¤",
                or: "æˆ–",
                scanQr: "æŽƒæ QR Code / è¼¸å…¥ PIN",
                findCode: "åœ¨è©²åœ°é»žå°‹æ‰¾ä»£ç¢¼ã€‚",
                scanBtn: "æŽƒæ QR Code",
                scanning: "æŽƒæä¸­...",
                enterPin: "è¼¸å…¥ 4 ä½ PIN",
                go: "ç¢ºå®š",
                invalidPin: "PIN ç„¡æ•ˆ",
                bypass: "ç•¥éŽ (é™¤éŒ¯)",
                challenge: "æŒ‘æˆ°",
                memories: "è§£éŽ–å›žæ†¶ï¼",
                readStories: "é–±è®€æ ¡å‹çš„æ•…äº‹",
                collectClose: "é ˜å–å°ç« ä¸¦é—œé–‰",
                adminPortal: "ç®¡ç†å“¡å¹³å°",
                totalUsers: "ç¸½ç”¨æˆ¶",
                totalStamps: "ç¸½ç™¼å‡ºå°ç« ",
                userActivity: "ç”¨æˆ¶æ´»å‹•è¨˜éŒ„",
                overseasActivation: "æµ·å¤–ç‰ˆå•Ÿç”¨",
                enterEventCode: "è¼¸å…¥å…¨çƒæ´»å‹•ä»£ç¢¼ä»¥è§£éŽ–æ ¡åœ’åœ°åœ–ã€‚",
                unlockCampus: "è§£éŽ–æ ¡åœ’",
                invalidEventCode: "ä»£ç¢¼ç„¡æ•ˆã€‚è«‹å˜—è©¦ 8888ã€‚",
                myStamps: "æˆ‘çš„å°ç« é›†",
                collectAll: "æ”¶é›†æ‰€æœ‰è¦–è¦ºå°ç« ï¼",
                clue: "å°‹æ‰¾ä»£ç¢¼çš„æç¤ºï¼š",
                incorrect: "ç­”æ¡ˆéŒ¯èª¤ï¼ä¸‹æ¬¡å†è©¦ã€‚",
                alreadyClearedTitle: "å·²å®Œæˆ",
                alreadyClearedMsg: "ä½ å·²ç¶“æ”¶é›†äº†é€™å€‹å°ç« ï¼",
                stampCollectedTitle: "ç²å¾—å°ç« ï¼",
                stampCollectedMsg: "ä½ è´å¾—äº†å°ç« ï¼",
                password: "å¯†ç¢¼",
                login: "ç™»å…¥",
                tutorialTitle: "éŠæˆ²çŽ©æ³•",
                tutorialIntro: "æ­¡è¿ŽåƒåŠ ç†å¤§å°‹å¯¶æ´»å‹•ï¼",
                tutorialLocal: "ðŸ“ æœ¬åœ°æ¨¡å¼ï¼šè¦ªèº«å‰å¾€æ ¡åœ’åœ°é»žï¼ŒæŽƒæè©²åœ°é»žçš„ QR Code ä¸¦å›žç­”å•é¡Œä»¥è§£éŽ–å°ç« ã€‚",
                tutorialOverseas: "ðŸŒ æµ·å¤–æ¨¡å¼ï¼šè¼¸å…¥æ´»å‹•ä»£ç¢¼è§£éŽ–è™›æ“¬åœ°åœ–ï¼Œåœ¨å®¶ä¸­ä¹Ÿèƒ½æŽ¢ç´¢ã€‚",
                tutorialGoal: "ðŸ† ç›®æ¨™ï¼šæ”¶é›†å…¨éƒ¨ 10 å€‹å°ç« ä»¥è´å–å¤§çŽï¼",
                tutorialStart: "æ˜Žç™½äº†ï¼Œé–‹å§‹ï¼",
                lockedTitle: "åœ°é»žå·²éŽ–å®š",
                lockedMsg: "ä½ å¿…é ˆå…ˆå®Œæˆå…¶ä»– 9 å€‹åœ°é»žï¼Œæ‰èƒ½æŒ‘æˆ°æœ€çµ‚é—œå¡ï¼",
                grandSuccessTitle: "å¤§ç²å…¨å‹ï¼",
                grandSuccessMsg: "æ­å–œï¼ä½ å·²æˆåŠŸå¾æœæ‰€æœ‰ 10 å€‹åœ°é»žï¼æ„Ÿè¬ä½ æŽ¢ç´¢ç†å¤§ã€‚",
                qrTab: "QR ç¢¼",
                scanError: "æŽƒæå™¨éŒ¯èª¤ã€‚è«‹å˜—è©¦è¼¸å…¥ PINã€‚",
                wrongLocation: "åœ°é»žéŒ¯èª¤ï¼æ­¤ QR ç¢¼å±¬æ–¼",
                giftTitle: "é ˜å–å¤§çŽ",
                giftAsk: "ä½ å·²å®Œæˆåœ°åœ–ï¼æƒ³è¦æˆ‘å€‘å¯„é€ç´€å¿µå“çµ¦ä½ å—Žï¼Ÿ",
                giftYes: "å¥½ï¼Œè«‹å¯„çµ¦æˆ‘ï¼",
                giftNo: "ä¸ç”¨äº†ï¼Œè¬è¬",
                confirmEmail: "ç¢ºèªé›»éƒµ",
                shippingAddr: "éƒµå¯„åœ°å€",
                giftSubmitted: "å·²æ”¶åˆ°è«‹æ±‚ï¼æˆ‘å€‘ç¨å¾Œæœƒè¯çµ¡ä½ ã€‚",
                submitClaim: "æäº¤ç”³è«‹",
                authError: "é©—è­‰éŒ¯èª¤ã€‚æ­£åœ¨ä»¥é›¢ç·šæ¨¡å¼é‹è¡Œã€‚",
                statsTab: "æ•¸æ“šåˆ†æž"
            },
            sc: {
                appTitle: "ç†å¤§å¯»å®",
                welcome: "æ¬¢è¿Žæ¥åˆ°ç†å¤§å¯»å®",
                subtitle: "å‚ä¸Žæ ¡å›­æŽ¢ç´¢ä¹‹æ—…",
                adminLogin: "ç®¡ç†å‘˜ç™»å…¥",
                fullName: "å…¨å",
                email: "ç†å¤§ç”µé‚®",
                mode: "å‚ä¸Žæ¨¡å¼",
                local: "æœ¬åœ° (æ ¡å›­)",
                overseas: "æµ·å¤–",
                role: "èº«åˆ†",
                visitor: "è®¿å®¢",
                student: "åœ¨è¯»å­¦ç”Ÿ",
                grad: "æ¯•ä¸šç”Ÿ",
                staff: "æ•™èŒå‘˜",
                prog: "è¯¾ç¨‹",
                gradYear: "æ¯•ä¸šå¹´ä»½",
                startBtn: "å¼€å§‹å¯»å®",
                adminBtn: "ç®¡ç†å‘˜ç™»å…¥",
                adminMode: "ç®¡ç†å‘˜æ¨¡å¼",
                findConquer: "æŽ¢ç´¢ä¸Žå¾æœ",
                stamps: "å°ç« ",
                goToLoc: "å‰å¾€åœ°ç‚¹è§£é”å°ç« ",
                earnStamp: "èµ¢å–å°ç« ï¼",
                gpsVerify: "GPS å®šä½éªŒè¯",
                checkGps: "æ£€æŸ¥ GPS",
                locating: "å®šä½ä¸­...",
                verified: "éªŒè¯æˆåŠŸï¼",
                tooFar: "è·ç¦»å¤ªè¿œï¼",
                gpsError: "GPS é”™è¯¯",
                or: "æˆ–",
                scanQr: "æ‰«æ QR Code / è¾“å…¥ PIN",
                findCode: "åœ¨è¯¥åœ°ç‚¹å¯»æ‰¾ä»£ç ã€‚",
                scanBtn: "æ‰«æ QR Code",
                scanning: "æ‰«æä¸­...",
                enterPin: "è¾“å…¥ 4 ä½ PIN",
                go: "ç¡®å®š",
                invalidPin: "PIN æ— æ•ˆ",
                bypass: "ç•¥è¿‡ (é™¤é”™)",
                challenge: "æŒ‘æˆ˜",
                memories: "è§£é”å›žå¿†ï¼",
                readStories: "é˜…è¯»æ ¡å‹çš„æ•…äº‹",
                collectClose: "é¢†å–å°ç« å¹¶å…³é—­",
                adminPortal: "ç®¡ç†å‘˜å¹³å°",
                totalUsers: "æ€»ç”¨æˆ·",
                totalStamps: "æ€»å‘å‡ºå°ç« ",
                userActivity: "ç”¨æˆ·æ´»åŠ¨è®°å½•",
                overseasActivation: "æµ·å¤–ç‰ˆå¯ç”¨",
                enterEventCode: "è¾“å…¥å…¨çƒæ´»åŠ¨ä»£ç ä»¥è§£é”æ ¡å›­åœ°å›¾ã€‚",
                unlockCampus: "è§£é”æ ¡å›­",
                invalidEventCode: "ä»£ç æ— æ•ˆã€‚è¯·å°è¯• 8888ã€‚",
                myStamps: "æˆ‘çš„å°ç« é›†",
                collectAll: "æ”¶é›†æ‰€æœ‰è§†è§‰å°ç« ï¼",
                clue: "å¯»æ‰¾ä»£ç çš„æç¤ºï¼š",
                incorrect: "ç­”æ¡ˆé”™è¯¯ï¼ä¸‹æ¬¡å†è¯•ã€‚",
                alreadyClearedTitle: "å·²å®Œæˆ",
                alreadyClearedMsg: "ä½ å·²ç»æ”¶é›†äº†è¿™ä¸ªå°ç« ï¼",
                stampCollectedTitle: "èŽ·å¾—å°ç« ï¼",
                stampCollectedMsg: "ä½ èµ¢å¾—äº†å°ç« ï¼",
                password: "å¯†ç ",
                login: "ç™»å…¥",
                tutorialTitle: "æ¸¸æˆçŽ©æ³•",
                tutorialIntro: "æ¬¢è¿Žå‚åŠ ç†å¤§å¯»å®æ´»åŠ¨ï¼",
                tutorialLocal: "ðŸ“ æœ¬åœ°æ¨¡å¼ï¼šäº²èº«å‰å¾€æ ¡å›­åœ°ç‚¹ï¼Œæ‰«æè¯¥åœ°ç‚¹çš„ QR Code å¹¶å›žç­”é—®é¢˜ä»¥è§£é”å°ç« ã€‚",
                tutorialOverseas: "ðŸŒ æµ·å¤–æ¨¡å¼ï¼šè¾“å…¥æ´»åŠ¨ä»£ç è§£é”è™šæ‹Ÿåœ°å›¾ï¼Œåœ¨å®¶ä¸­ä¹Ÿèƒ½æŽ¢ç´¢ã€‚",
                tutorialGoal: "ðŸ† ç›®æ ‡ï¼šæ”¶é›†å…¨éƒ¨ 10 ä¸ªå°ç« ä»¥èµ¢å–å¤§å¥–ï¼",
                tutorialStart: "æ˜Žç™½äº†ï¼Œå¼€å§‹ï¼",
                lockedTitle: "åœ°ç‚¹å·²é”å®š",
                lockedMsg: "ä½ å¿…é¡»å…ˆå®Œæˆå…¶ä»– 9 ä¸ªåœ°ç‚¹ï¼Œæ‰èƒ½æŒ‘æˆ˜æœ€ç»ˆå…³å¡ï¼",
                grandSuccessTitle: "å¤§èŽ·å…¨èƒœï¼",
                grandSuccessMsg: "æ­å–œï¼ä½ å·²æˆåŠŸå¾æœæ‰€æœ‰ 10 ä¸ªåœ°ç‚¹ï¼æ„Ÿè°¢ä½ æŽ¢ç´¢ç†å¤§ã€‚",
                qrTab: "QR ç ",
                scanError: "æ‰«æå™¨é”™è¯¯ã€‚è¯·å°è¯•è¾“å…¥ PINã€‚",
                wrongLocation: "åœ°ç‚¹é”™è¯¯ï¼æ­¤ QR ç å±žäºŽ",
                giftTitle: "é¢†å–å¤§å¥–",
                giftAsk: "ä½ å·²å®Œæˆåœ°å›¾ï¼æƒ³è¦æˆ‘ä»¬å¯„é€çºªå¿µå“ç»™ä½ å—ï¼Ÿ",
                giftYes: "å¥½ï¼Œè¯·å¯„ç»™æˆ‘ï¼",
                giftNo: "ä¸ç”¨äº†ï¼Œè°¢è°¢",
                confirmEmail: "ç¡®è®¤ç”µé‚®",
                shippingAddr: "é‚®å¯„åœ°å€",
                giftSubmitted: "å·²æ”¶åˆ°è¯·æ±‚ï¼æˆ‘ä»¬ç¨åŽä¼šè”ç»œä½ ã€‚",
                submitClaim: "æäº¤ç”³è¯·",
                authError: "éªŒè¯é”™è¯¯ã€‚æ­£åœ¨ä»¥ç¦»çº¿æ¨¡å¼è¿è¡Œã€‚",
                statsTab: "æ•°æ®åˆ†æž"
            }
        };

        // --- Configuration & Constants ---
        
        const LOCATIONS = [
            { id: 'core_z', name: {en:'Core Z (Block Z)', tc:'Z åº§ (Core Z)', sc:'Z åº§ (Core Z)'}, lat: 22.3050, lng: 114.1780, mapX: 15, mapY: 20, icon: 'fa-cube', code: '1234', hint: {en:'On the pillar near the canteen entrance.', tc:'åœ¨é£¯å ‚å…¥å£é™„è¿‘çš„æŸ±å­ä¸Šã€‚', sc:'åœ¨é£Ÿå ‚å…¥å£é™„è¿‘çš„æŸ±å­ä¸Šã€‚'} },
            { id: 'core_m', name: {en:'Core M (Li Ka Shing)', tc:'æŽå˜‰èª æ¨“ (Core M)', sc:'æŽå˜‰è¯šæ¥¼ (Core M)'}, lat: 22.3045, lng: 114.1785, mapX: 25, mapY: 45, icon: 'fa-building', code: '1234', hint: {en:'Near the nursing labs entrance.', tc:'åœ¨è­·ç†å¯¦é©—å®¤å…¥å£é™„è¿‘ã€‚', sc:'åœ¨æŠ¤ç†å®žéªŒå®¤å…¥å£é™„è¿‘ã€‚'} },
            { id: 'core_v', name: {en:'Core V (JCIT)', tc:'è³½é¦¬æœƒå‰µæ–°æ¨“ (Core V)', sc:'èµ›é©¬ä¼šåˆ›æ–°æ¥¼ (Core V)'}, lat: 22.3060, lng: 114.1790, mapX: 85, mapY: 15, icon: 'fa-drafting-compass', code: '1234', hint: {en:'Next to the escalator on the ground floor.', tc:'åœ¨åœ°ä¸‹æ‰¶æ‰‹é›»æ¢¯æ—ã€‚', sc:'åœ¨åœ°ä¸‹æ‰¶æ‰‹ç”µæ¢¯æ—ã€‚'} },
            { id: 'lib', name: {en:'Main Library', tc:'åŒ…çŽ‰å‰›åœ–æ›¸é¤¨', sc:'åŒ…çŽ‰åˆšå›¾ä¹¦é¦†'}, lat: 22.3043, lng: 114.1796, mapX: 50, mapY: 35, icon: 'fa-book', code: '1234', hint: {en:'It is in the corner of the reading zone in 1/F and near the green sofa.', tc:'åœ¨1æ¨“é–±è®€å€çš„è§’è½ï¼Œé è¿‘ç¶ è‰²æ²™ç™¼ã€‚', sc:'åœ¨1æ¥¼é˜…è¯»åŒºçš„è§’è½ï¼Œé è¿‘ç»¿è‰²æ²™å‘ã€‚'} },
            { id: 'core_s', name: {en:'Core S (Communal)', tc:'æ–‡åº·å¤§æ¨“ (Core S)', sc:'æ–‡åº·å¤§æ¥¼ (Core S)'}, lat: 22.3038, lng: 114.1805, mapX: 50, mapY: 55, icon: 'fa-users', code: '1234', hint: {en:'On the notice board near the SU office.', tc:'åœ¨å­¸ç”Ÿæœƒè¾¦å…¬å®¤é™„è¿‘çš„å‘Šç¤ºæ¿ä¸Šã€‚', sc:'åœ¨å­¦ç”Ÿä¼šåŠžå…¬å®¤é™„è¿‘çš„å‘Šç¤ºæ¿ä¸Šã€‚'} },
            { id: 'core_g', name: {en:'Core G (Wing On)', tc:'æ°¸å®‰å»£å ´ (Core G)', sc:'æ°¸å®‰å¹¿åœº (Core G)'}, lat: 22.3038, lng: 114.1810, mapX: 60, mapY: 55, icon: 'fa-flask', code: '1234', hint: {en:'Beside the chemistry lab safety poster.', tc:'åœ¨åŒ–å­¸å¯¦é©—å®¤å®‰å…¨æµ·å ±æ—é‚Šã€‚', sc:'åœ¨åŒ–å­¦å®žéªŒå®¤å®‰å…¨æµ·æŠ¥æ—è¾¹ã€‚'} },
            { id: 'core_h', name: {en:'Core H', tc:'H åº§ (Core H)', sc:'H åº§ (Core H)'}, lat: 22.3035, lng: 114.1812, mapX: 65, mapY: 60, icon: 'fa-laptop-code', code: '1234', hint: {en:'On the wall near the podium exit.', tc:'åœ¨å¹³å°å‡ºå£é™„è¿‘çš„ç‰†ä¸Šã€‚', sc:'åœ¨å¹³å°å‡ºå£é™„è¿‘çš„å¢™ä¸Šã€‚'} },
            { id: 'core_y', name: {en:'Core Y (Lee Shau Kee)', tc:'æŽå…†åŸºæ¨“ (Core Y)', sc:'æŽå…†åŸºæ¥¼ (Core Y)'}, lat: 22.3030, lng: 114.1815, mapX: 75, mapY: 70, icon: 'fa-chalkboard-teacher', code: '1234', hint: {en:'Near the auditorium ticket counter.', tc:'åœ¨ç¶œè—é¤¨å”®ç¥¨è™•é™„è¿‘ã€‚', sc:'åœ¨ç»¼è‰ºé¦†å”®ç¥¨å¤„é™„è¿‘ã€‚'} },
            { id: 'core_u', name: {en:'Core U (Industry Ctr)', tc:'å·¥æ¥­ä¸­å¿ƒ (Core U)', sc:'å·¥ä¸šä¸­å¿ƒ (Core U)'}, lat: 22.3040, lng: 114.1820, mapX: 85, mapY: 50, icon: 'fa-tools', code: '1234', hint: {en:'Next to the 3D printing workshop door.', tc:'åœ¨ 3D æ‰“å°å·¥ä½œå®¤é–€å£æ—é‚Šã€‚', sc:'åœ¨ 3D æ‰“å°å·¥ä½œå®¤é—¨å£æ—è¾¹ã€‚'} },
            // 10th Location - Final Boss
            { id: 'core_a', name: {en:'Core A (Chung Sze Yuen)', tc:'é¾å£«å…ƒæ¨“ (Core A)', sc:'é’Ÿå£«å…ƒæ¥¼ (Core A)'}, lat: 22.3033, lng: 114.1793, mapX: 20, mapY: 85, icon: 'fa-university', code: '1234', hint: {en:'Near the main entrance fountain.', tc:'åœ¨æ­£é–€å™´æ°´æ± é™„è¿‘ã€‚', sc:'åœ¨æ­£é—¨å–·æ°´æ± é™„è¿‘ã€‚'} },
        ];

        const QUESTIONS = {
            'lib': { 
                text: {en:'How many floors does the Main Library have?', tc:'åŒ…çŽ‰å‰›åœ–æ›¸é¤¨å…±æœ‰å¤šå°‘å±¤ï¼Ÿ', sc:'åŒ…çŽ‰åˆšå›¾ä¹¦é¦†å…±æœ‰å¤šå°‘å±‚ï¼Ÿ'}, 
                options: {en:['4', '5', '6', '7'], tc:['4', '5', '6', '7'], sc:['4', '5', '6', '7']}, 
                answer: {en:'6', tc:'6', sc:'6'} 
            },
            'core_z': { 
                text: {en:'What is Block Z famous for?', tc:'Z åº§ä»¥ä»€éº¼èžåï¼Ÿ', sc:'Z åº§ä»¥ä»€ä¹ˆé—»åï¼Ÿ'}, 
                options: {en:['Design', 'Food', 'Construction', 'Gardens'], tc:['è¨­è¨ˆ', 'ç¾Žé£Ÿ', 'å»ºç¯‰', 'èŠ±åœ’'], sc:['è®¾è®¡', 'ç¾Žé£Ÿ', 'å»ºç­‘', 'èŠ±å›­']}, 
                answer: {en:'Food', tc:'ç¾Žé£Ÿ', sc:'ç¾Žé£Ÿ'} 
            },
            'core_a': {
                text: {en:'What year was PolyU established?', tc:'ç†å¤§æ˜¯å“ªä¸€å¹´æˆç«‹çš„ï¼Ÿ', sc:'ç†å¤§æ˜¯å“ªä¸€å¹´æˆç«‹çš„ï¼Ÿ'},
                options: {en:['1937', '1972', '1994', '2000'], tc:['1937', '1972', '1994', '2000'], sc:['1937', '1972', '1994', '2000']},
                answer: {en:'1937', tc:'1937', sc:'1937'}
            },
            'default': {
                text: {en:'Who designed this building?', tc:'é€™åº§å»ºç¯‰æ˜¯èª°è¨­è¨ˆçš„ï¼Ÿ', sc:'è¿™åº§å»ºç­‘æ˜¯è°è®¾è®¡çš„ï¼Ÿ'},
                options: {en:['Zaha Hadid', 'Norman Foster', 'IM Pei', 'Frank Gehry'], tc:['Zaha Hadid', 'Norman Foster', 'IM Pei', 'Frank Gehry'], sc:['Zaha Hadid', 'Norman Foster', 'IM Pei', 'Frank Gehry']},
                answer: {en:'Zaha Hadid', tc:'Zaha Hadid', sc:'Zaha Hadid'}
            }
        };

        const getQuestion = (id, lang) => {
            const q = QUESTIONS[id] || QUESTIONS['default'];
            return {
                text: q.text[lang] || q.text['en'],
                options: q.options[lang] || q.options['en'],
                answer: q.answer[lang] || q.answer['en']
            };
        };

        const ALUMNI_STORIES = {
            'lib': [
                { user: 'Sarah (Grad 2019)', text: {en:"I spent 3 nights straight in the 24h reading room.", tc:"æˆ‘åœ¨ 24 å°æ™‚é–±è¦½å®¤é€£çºŒç†¬äº† 3 å€‹æ™šä¸Šã€‚", sc:"æˆ‘åœ¨ 24 å°æ—¶é˜…è§ˆå®¤è¿žç»­ç†¬äº† 3 ä¸ªæ™šä¸Šã€‚"} },
                { user: 'Jason (Grad 2021)', text: {en:"The LibCafe mocha kept me alive.", tc:"LibCafe çš„æ‘©å¡å’–å•¡æ•‘äº†æˆ‘ä¸€å‘½ã€‚", sc:"LibCafe çš„æ‘©å¡å’–å•¡æ•‘äº†æˆ‘ä¸€å‘½ã€‚"} },
                { user: 'Emily (Grad 2015)', text: {en:"I met my husband on the 4th floor quiet zone.", tc:"æˆ‘åœ¨ 4 æ¨“éœéŸ³å€é‡è¦‹äº†æˆ‘ä¸ˆå¤«ã€‚", sc:"æˆ‘åœ¨ 4 æ¥¼é™éŸ³åŒºé‡è§çš„ä¸ˆå¤«ã€‚"} }
            ],
            'core_a': [
                { user: 'Dr. Lee', text: {en:"The red bricks represent our heritage.", tc:"ç´…ç£šä»£è¡¨äº†æˆ‘å€‘çš„å‚³æ‰¿ã€‚", sc:"çº¢ç –ä»£è¡¨äº†æˆ‘ä»¬çš„ä¼ æ‰¿ã€‚"} },
                { user: 'Alumni 85', text: {en:"Taking graduation photos at the fountain is a must.", tc:"åœ¨å™´æ°´æ± æ‹ç•¢æ¥­ç…§æ˜¯å¿…é ˆçš„ã€‚", sc:"åœ¨å–·æ°´æ± æ‹æ¯•ä¸šç…§æ˜¯å¿…é¡»çš„ã€‚"} },
                { user: 'Jane', text: {en:"The entrance always feels welcoming.", tc:"å…¥å£ç¸½æ˜¯çµ¦äººè¦ªåˆ‡çš„æ„Ÿè¦ºã€‚", sc:"å…¥å£æ€»æ˜¯ç»™äººäº²åˆ‡çš„æ„Ÿè§‰ã€‚"} }
            ],
            'default': [
                { user: 'PolyU Alum', text: {en:"This place holds so many memories.", tc:"é€™å€‹åœ°æ–¹å……æ»¿äº†å›žæ†¶ã€‚", sc:"è¿™ä¸ªåœ°æ–¹å……æ»¡äº†å›žå¿†ã€‚"} },
                { user: 'Class of 2018', text: {en:"One of my favorite spots.", tc:"æˆ‘æœ€å–œæ­¡çš„åœ°é»žä¹‹ä¸€ã€‚", sc:"æˆ‘æœ€å–œæ¬¢çš„åœ°ç‚¹ä¹‹ä¸€ã€‚"} },
                { user: 'Mike', text: {en:"Always crowded but full of energy.", tc:"ç¸½æ˜¯å¾ˆå¤šäººï¼Œä½†å……æ»¿æ´»åŠ›ã€‚", sc:"æ€»æ˜¯å¾ˆå¤šäººï¼Œä½†å……æ»¡æ´»åŠ›ã€‚"} }
            ]
        };

        const getStories = (locId, lang) => {
            const stories = ALUMNI_STORIES[locId] || ALUMNI_STORIES['default'];
            return stories.map(s => ({
                user: s.user,
                text: s.text[lang] || s.text['en']
            }));
        };

        // --- Components ---

        const LanguageSwitcher = ({ lang, setLang, light = false }) => {
            return (
                <div className={`flex rounded-lg overflow-hidden border ${light ? 'border-white/30' : 'border-gray-300'}`}>
                    {['en', 'tc', 'sc'].map(l => (
                        <button key={l} onClick={() => setLang(l)} 
                            className={`px-3 py-1 text-xs font-bold transition-colors
                            ${lang === l 
                                ? (light ? 'bg-white text-[#A6192E]' : 'bg-[#A6192E] text-white') 
                                : (light ? 'bg-transparent text-white hover:bg-white/10' : 'bg-white text-gray-500 hover:bg-gray-100')}`}>
                            {l.toUpperCase()}
                        </button>
                    ))}
                </div>
            );
        };

        // NEW: Gift Claim Modal
        const GiftClaimModal = ({ user, onClose, lang, onSubmit }) => {
            const [step, setStep] = useState(1); // 1: Ask, 2: Form, 3: Done
            const [formData, setFormData] = useState({ 
                email: user.email, 
                address: '' 
            });
            const t = TRANSLATIONS[lang];

            const handleSubmit = () => {
                onSubmit(formData);
                setStep(3);
            };

            return (
                <div className="fixed inset-0 z-[80] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 fade-in">
                    <div className="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm text-center pop-in border-t-8 border-[#A6192E]">
                        
                        {/* Step 1: Ask */}
                        {step === 1 && (
                            <>
                                <div className="w-16 h-16 rounded-full bg-yellow-100 text-yellow-600 flex items-center justify-center text-3xl mx-auto mb-4">
                                    <i className="fa fa-gift"></i>
                                </div>
                                <h3 className="text-xl font-bold text-gray-800 mb-2">{t.giftTitle}</h3>
                                <p className="text-gray-600 mb-6">{t.giftAsk}</p>
                                <div className="flex flex-col gap-3">
                                    <button onClick={() => setStep(2)} className="w-full bg-[#A6192E] text-white py-3 rounded-xl font-bold shadow-lg hover:bg-red-800 transition">
                                        {t.giftYes}
                                    </button>
                                    <button onClick={onClose} className="w-full bg-gray-100 text-gray-500 py-3 rounded-xl font-bold hover:bg-gray-200 transition">
                                        {t.giftNo}
                                    </button>
                                </div>
                            </>
                        )}

                        {/* Step 2: Form */}
                        {step === 2 && (
                            <>
                                <h3 className="text-lg font-bold text-gray-800 mb-4">{t.giftTitle}</h3>
                                <div className="text-left space-y-3 mb-6">
                                    <div>
                                        <label className="text-xs font-bold text-gray-500 block mb-1">{t.confirmEmail}</label>
                                        <input type="email" className="w-full p-2 border rounded bg-gray-50" 
                                            value={formData.email} 
                                            onChange={e => setFormData({...formData, email: e.target.value})}
                                        />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-gray-500 block mb-1">{t.shippingAddr}</label>
                                        <textarea className="w-full p-2 border rounded" rows="3"
                                            value={formData.address}
                                            onChange={e => setFormData({...formData, address: e.target.value})}
                                        ></textarea>
                                    </div>
                                </div>
                                <button onClick={handleSubmit} disabled={!formData.address} className="w-full bg-green-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-green-700 transition disabled:opacity-50">
                                    {t.submitClaim}
                                </button>
                            </>
                        )}

                        {/* Step 3: Success */}
                        {step === 3 && (
                            <>
                                <div className="w-16 h-16 rounded-full bg-green-100 text-green-600 flex items-center justify-center text-3xl mx-auto mb-4">
                                    <i className="fa fa-check"></i>
                                </div>
                                <h3 className="text-xl font-bold text-gray-800 mb-2">Success!</h3>
                                <p className="text-gray-600 mb-6">{t.giftSubmitted}</p>
                                <button onClick={onClose} className="w-full bg-gray-800 text-white py-3 rounded-xl font-bold hover:bg-black transition">
                                    Close
                                </button>
                            </>
                        )}
                    </div>
                </div>
            );
        };

        const NotificationModal = ({ title, message, type, customIcon, onClose, lang }) => {
            const t = TRANSLATIONS[lang];
            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/40 backdrop-blur-sm p-4 fade-in">
                    <div className="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm text-center pop-in border-t-4 border-[#A6192E]">
                        <div className="flex justify-center mb-4">
                            {customIcon ? (
                                <div className="stamp-circle stamp-earned w-20 h-20 text-3xl">
                                    <i className={`fa ${customIcon}`}></i>
                                </div>
                            ) : (
                                <div className={`w-16 h-16 rounded-full flex items-center justify-center text-3xl 
                                    ${type === 'success' ? 'bg-green-100 text-green-600' : 
                                      type === 'error' ? 'bg-red-100 text-red-600' : 'bg-blue-100 text-blue-600'}`}>
                                    <i className={`fa ${type === 'success' ? 'fa-trophy' : type === 'error' ? 'fa-lock' : 'fa-info'}`}></i>
                                </div>
                            )}
                        </div>
                        <h3 className="text-xl font-bold text-gray-800 mb-2">{title}</h3>
                        <p className="text-gray-600 mb-6">{message}</p>
                        <button onClick={onClose} className="w-full bg-[#A6192E] text-white py-3 rounded-xl font-bold shadow-lg hover:bg-red-800 transition">
                            {t.go}
                        </button>
                    </div>
                </div>
            );
        };

        const TutorialModal = ({ onClose, lang }) => {
            const t = TRANSLATIONS[lang];
            return (
                <div className="fixed inset-0 z-[80] flex items-center justify-center bg-black/70 backdrop-blur-sm p-4 fade-in">
                    <div className="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-md pop-in">
                        <div className="text-center mb-4">
                            <div className="w-12 h-12 bg-[#A6192E] rounded-full flex items-center justify-center text-white text-2xl mx-auto mb-3">
                                <i className="fa fa-question"></i>
                            </div>
                            <h2 className="text-2xl font-bold text-gray-800">{t.tutorialTitle}</h2>
                            <p className="text-sm text-gray-500">{t.tutorialIntro}</p>
                        </div>
                        <div className="space-y-4 text-sm text-gray-700 bg-gray-50 p-4 rounded-xl mb-6">
                            <p>{t.tutorialLocal}</p>
                            <p>{t.tutorialOverseas}</p>
                            <p className="font-bold text-[#A6192E]">{t.tutorialGoal}</p>
                        </div>
                        <button onClick={onClose} className="w-full bg-gray-900 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-black transition">
                            {t.tutorialStart}
                        </button>
                    </div>
                </div>
            );
        };

        const OverseasUnlockModal = ({ onUnlock, lang }) => {
            const [code, setCode] = useState('');
            const [error, setError] = useState(false);
            const MASTER_CODE = '8888';
            const t = TRANSLATIONS[lang];

            const handleUnlock = () => {
                if (code === MASTER_CODE) {
                    onUnlock();
                } else {
                    setError(true);
                }
            };

            return (
                <div className="fixed inset-0 z-[70] flex items-center justify-center bg-black/80 backdrop-blur-md p-4 fade-in">
                    <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-sm text-center pop-in border-t-4 border-blue-600">
                        <div className="w-16 h-16 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-3xl mx-auto mb-4">
                            <i className="fa fa-globe"></i>
                        </div>
                        <h3 className="text-2xl font-bold text-gray-800 mb-2">{t.overseasActivation}</h3>
                        <p className="text-gray-500 mb-6">{t.enterEventCode}</p>
                        <input 
                            type="text" 
                            className="w-full text-center text-2xl tracking-[0.5em] font-bold border-2 border-gray-300 rounded-lg p-3 mb-2 uppercase focus:border-blue-600 outline-none" 
                            placeholder="CODE"
                            maxLength="4"
                            value={code}
                            onChange={(e) => { setCode(e.target.value); setError(false); }}
                        />
                        {error && <p className="text-red-500 text-sm font-bold mb-4">{t.invalidEventCode}</p>}
                        <button onClick={handleUnlock} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-blue-700 transition mt-2">
                            {t.unlockCampus}
                        </button>
                    </div>
                </div>
            );
        };

        const StampBook = ({ locations, clearedLocations, onClose, lang }) => {
            const earnedCount = clearedLocations.length;
            const total = locations.length;
            const progress = (earnedCount / total) * 100;
            const t = TRANSLATIONS[lang];

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 fade-in">
                     <div className="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-lg relative max-h-[90vh] overflow-y-auto">
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100">
                            <i className="fa fa-times text-xl"></i>
                        </button>
                        <div className="text-center mb-6">
                            <h2 className="text-2xl font-bold text-[#A6192E] mb-1">{t.myStamps}</h2>
                            <p className="text-gray-500 text-sm">{t.collectAll}</p>
                            <div className="mt-4 flex items-center gap-2 max-w-xs mx-auto">
                                <div className="flex-grow h-2 bg-gray-200 rounded-full overflow-hidden">
                                    <div className="h-full bg-[#A6192E] transition-all duration-500" style={{width: `${progress}%`}}></div>
                                </div>
                                <span className="text-xs font-bold text-gray-600">{earnedCount}/{total}</span>
                            </div>
                        </div>
                        <div className="grid grid-cols-3 gap-4">
                            {locations.map(loc => {
                                const isEarned = clearedLocations.includes(loc.id);
                                return (
                                    <div key={loc.id} className={`flex flex-col items-center p-3 rounded-xl border-2 transition-all
                                        ${isEarned ? 'border-[#A6192E] bg-red-50' : 'border-gray-200 bg-gray-50'}`}>
                                        <div className={`stamp-circle mb-2 ${isEarned ? 'stamp-earned' : 'stamp-locked'}`}>
                                            <i className={`fa ${loc.icon}`}></i>
                                            {isEarned && (
                                                <div className="absolute -bottom-1 -right-1 w-6 h-6 bg-green-500 text-white text-xs rounded-full flex items-center justify-center border-2 border-white">
                                                    <i className="fa fa-check"></i>
                                                </div>
                                            )}
                                        </div>
                                        <span className={`text-[10px] font-bold text-center leading-tight ${isEarned ? 'text-[#A6192E]' : 'text-gray-400'}`}>
                                            {loc.name[lang]}
                                        </span>
                                    </div>
                                )
                            })}
                        </div>
                     </div>
                </div>
            );
        };

        const Register = ({ onRegister, onAdminLogin, lang, setLang }) => {
            const [role, setRole] = useState('none');
            const [version, setVersion] = useState('local');
            const [formData, setFormData] = useState({ name: '', email: '', programme: '', gradYear: '' });
            const [adminPass, setAdminPass] = useState('');
            const [showTutorial, setShowTutorial] = useState(true); 
            
            const t = TRANSLATIONS[lang];
            const isAdminInput = formData.name.trim().toLowerCase() === 'admin';

            const handleSubmit = (e) => {
                e.preventDefault();
                
                if (isAdminInput) {
                    if (adminPass === 'pwadmin') {
                        onAdminLogin();
                    } else {
                        alert('Invalid Admin Password');
                    }
                } else {
                    if (!formData.name || !formData.email) return alert('Name and Email required');
                    onRegister({ ...formData, role, version });
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4 bg-gray-100">
                    {/* Tutorial Modal Overlay */}
                    {showTutorial && <TutorialModal onClose={() => setShowTutorial(false)} lang={lang} />}

                    <div className="bg-white p-6 md:p-8 rounded-2xl shadow-xl w-full max-w-md border-t-8 border-[#A6192E] relative">
                        <div className="absolute top-4 right-4">
                            <LanguageSwitcher lang={lang} setLang={setLang} />
                        </div>

                        <div className="text-center mb-6 pt-6">
                            <div className="bg-[#A6192E] text-white w-16 h-16 rounded-full flex items-center justify-center text-2xl font-bold mx-auto mb-4">P</div>
                            <h1 className="text-2xl font-bold text-gray-800">{t.appTitle}</h1>
                            <p className="text-sm text-gray-500">{t.subtitle}</p>
                        </div>

                        <form onSubmit={handleSubmit} className="space-y-4 fade-in">
                            <input required placeholder={t.fullName} className="input-field" 
                                value={formData.name} 
                                onChange={e => setFormData({...formData, name: e.target.value})} 
                            />
                            
                            {isAdminInput ? (
                                <div className="pop-in">
                                    <input required type="password" placeholder={t.password} className="input-field bg-gray-50 border-gray-300"
                                        value={adminPass}
                                        onChange={e => setAdminPass(e.target.value)}
                                    />
                                </div>
                            ) : (
                                <div className="space-y-4 fade-in">
                                    <input required placeholder={t.email} type="email" className="input-field" value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})} />
                                    <div>
                                        <label className="label">{t.mode}</label>
                                        <div className="grid grid-cols-2 gap-2">
                                            <button type="button" onClick={() => setVersion('local')} 
                                                className={`p-2 rounded-lg border-2 font-bold text-sm ${version === 'local' ? 'border-[#A6192E] bg-red-50 text-[#A6192E]' : 'border-gray-200 text-gray-400'}`}>
                                                <i className="fa fa-map-marker-alt mr-2"></i> {t.local}
                                            </button>
                                            <button type="button" onClick={() => setVersion('overseas')} 
                                                className={`p-2 rounded-lg border-2 font-bold text-sm ${version === 'overseas' ? 'border-blue-600 bg-blue-50 text-blue-600' : 'border-gray-200 text-gray-400'}`}>
                                                <i className="fa fa-globe mr-2"></i> {t.overseas}
                                            </button>
                                        </div>
                                    </div>
                                    <select className="input-field" value={role} onChange={e => setRole(e.target.value)}>
                                        <option value="none">{t.visitor}</option>
                                        <option value="student">{t.student}</option>
                                        <option value="grad">{t.grad}</option>
                                        <option value="staff">{t.staff}</option>
                                    </select>
                                    {(role === 'student' || role === 'grad') && (
                                        <input required placeholder={t.prog} className="input-field fade-in" value={formData.programme} onChange={e => setFormData({...formData, programme: e.target.value})} />
                                    )}
                                    {(role === 'grad') && (
                                        <input required placeholder={t.gradYear} type="number" className="input-field fade-in" value={formData.gradYear} onChange={e => setFormData({...formData, gradYear: e.target.value})} />
                                    )}
                                </div>
                            )}

                            <button type="submit" className={`w-full text-white py-3 rounded-xl font-bold hover:opacity-90 transition shadow-lg ${isAdminInput ? 'bg-gray-800' : 'bg-[#A6192E]'}`}>
                                {isAdminInput ? t.login : t.startBtn}
                            </button>
                            
                            {!isAdminInput && (
                                <button type="button" onClick={() => setShowTutorial(true)} className="w-full text-xs text-gray-400 hover:text-[#A6192E] underline mt-2">
                                    {t.tutorialTitle}
                                </button>
                            )}
                        </form>
                    </div>
                </div>
            );
        };

        const MapScreen = ({ user, locations, clearedLocations, onOpenStampBook, onSelectLocation, onSimulateTime, onOpenAdmin, lang, setLang }) => {
            const t = TRANSLATIONS[lang];
            const isLocal = user.version === 'local';
            // 10th location (index 9) requires 9 stamps
            const canAccess10th = !isLocal || clearedLocations.length >= 9;

            return (
                <div className="flex flex-col h-screen bg-gray-50">
                    <header className="bg-white shadow-sm p-4 z-10 flex justify-between items-center flex-shrink-0">
                        <div className="flex items-center space-x-2">
                            <div className="w-8 h-8 bg-[#A6192E] rounded-full flex items-center justify-center text-white font-bold text-sm">P</div>
                            <div>
                                <h1 className="font-bold text-gray-800 leading-tight">{t.appTitle}</h1>
                                <div className="flex items-center gap-2">
                                    <p className="text-[10px] text-gray-500">{user.role === 'admin' ? t.adminMode : t.findConquer}</p>
                                    {user.version === 'overseas' && <span className="text-[10px] bg-blue-100 text-blue-700 px-1 rounded font-bold">{t.overseas}</span>}
                                    {user.version === 'local' && <span className="text-[10px] bg-red-100 text-red-700 px-1 rounded font-bold">{t.local}</span>}
                                </div>
                            </div>
                        </div>
                        <div className="flex items-center gap-3">
                            <LanguageSwitcher lang={lang} setLang={setLang} />
                            <button onClick={onOpenStampBook} className="bg-yellow-100 text-yellow-800 px-3 py-1.5 rounded-full text-xs font-bold flex items-center gap-2 hover:bg-yellow-200 transition shadow-sm border border-yellow-200">
                                <i className="fa fa-book-open"></i> 
                                <span>{clearedLocations.length} {t.stamps}</span>
                            </button>
                        </div>
                    </header>
                    <main className="flex-grow relative overflow-hidden p-4 md:p-8">
                        <div className="w-full h-full max-w-5xl mx-auto map-container shadow-inner relative border border-gray-300">
                            {locations.map(loc => {
                                const isCleared = clearedLocations.includes(loc.id);
                                // Core A is the 10th location
                                const is10th = loc.id === 'core_a';
                                const isLocked = is10th && !canAccess10th && !isCleared;

                                return (
                                    <div key={loc.id}
                                        className={`absolute cursor-pointer flex flex-col items-center group map-pin 
                                            ${isCleared ? 'opacity-75' : ''} ${isLocked ? 'locked grayscale' : ''}`}
                                        style={{ left: `${loc.mapX}%`, top: `${loc.mapY}%` }}
                                        onClick={() => onSelectLocation(loc, isLocked)}
                                    >
                                        <div className={`w-8 h-8 md:w-10 md:h-10 rounded-full border-2 flex items-center justify-center shadow-lg transition-transform 
                                            ${isCleared ? 'bg-green-500 border-white text-white' : (isLocked ? 'bg-gray-400 border-white text-white' : 'bg-[#A6192E] border-white text-white group-hover:scale-110')}`}>
                                            <i className={`fa ${isCleared ? 'fa-check' : (isLocked ? 'fa-lock' : loc.icon)} text-sm`}></i>
                                        </div>
                                        <div className="pin-label">
                                            {loc.name[lang]}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </main>
                    <div className="bg-white border-t p-4 flex-shrink-0 safe-area-bottom">
                        <div className="max-w-md mx-auto grid grid-cols-2 gap-4">
                            {user.role === 'admin' ? (
                                <button onClick={onOpenAdmin} className="bg-blue-800 text-white py-3 rounded-lg font-bold text-sm shadow hover:bg-blue-700 relative col-span-2">
                                    <i className="fa fa-chart-bar mr-2"></i> {t.adminPortal}
                                </button>
                            ) : (
                                <div className="text-xs text-center text-gray-400 col-span-2 flex items-center justify-center italic">
                                    {t.goToLoc}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const LocationModal = ({ location, onClose, onStartQuiz, onDebugTeleport, lang, onScanError }) => {
            const [scanStatus, setScanStatus] = useState('idle'); 
            const [inputCode, setInputCode] = useState('');
            const [codeError, setCodeError] = useState(false);
            const t = TRANSLATIONS[lang];
            const scannerRef = useRef(null);

            useEffect(() => {
                return () => {
                    if (scannerRef.current) {
                        scannerRef.current.clear();
                    }
                };
            }, []);

            const onScanSuccess = (decodedText) => {
                // Expected format: "POLYU_HUNT:location_id"
                const expectedCode = `POLYU_HUNT:${location.id}`;
                if (decodedText === expectedCode) {
                    if (scannerRef.current) scannerRef.current.clear();
                    setScanStatus('success');
                    setTimeout(onStartQuiz, 1000);
                } else {
                    // Wrong Location Scanned
                    // If user scanned another valid QR but not this one
                    if (decodedText.startsWith("POLYU_HUNT:")) {
                        alert(`${t.wrongLocation} ${decodedText.split(':')[1]}`);
                    } else {
                        alert("Invalid QR Code");
                    }
                }
            };

            const onScanFailure = (error) => {
                // handle scan failure, usually better to ignore frame errors to keep UI clean
                // console.warn(`Code scan error = ${error}`);
            };

            const startScanner = () => {
                setScanStatus('scanning');
                const html5QrcodeScanner = new Html5QrcodeScanner(
                    "reader",
                    { fps: 10, qrbox: { width: 250, height: 250 } },
                    /* verbose= */ false);
                
                html5QrcodeScanner.render(onScanSuccess, onScanFailure);
                scannerRef.current = html5QrcodeScanner;
            };

            const handleCodeVerify = () => {
                if(inputCode.trim() === location.code) {
                    onStartQuiz();
                } else {
                    setCodeError(true);
                }
            };

            return (
                <div className="fixed inset-0 z-50 flex items-end md:items-center justify-center bg-black/50 backdrop-blur-sm p-0 md:p-4 fade-in">
                    <div className="bg-white w-full md:max-w-md rounded-t-2xl md:rounded-2xl p-6 shadow-2xl slide-up max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-start mb-6">
                            <div>
                                <h2 className="text-2xl font-bold text-gray-800">{location.name[lang]}</h2>
                                <p className="text-sm text-gray-500 font-bold text-[#A6192E]">{t.earnStamp}</p>
                            </div>
                            <button onClick={onClose} className="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200"><i className="fa fa-times text-gray-600"></i></button>
                        </div>
                        
                        <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-r-lg mb-6">
                            <div className="flex items-start">
                                <i className="fa fa-lightbulb text-yellow-500 mt-1 mr-3"></i>
                                <div>
                                    <h4 className="font-bold text-yellow-800 text-sm">{t.clue}</h4>
                                    <p className="text-sm text-yellow-700 italic">"{location.hint[lang]}"</p>
                                </div>
                            </div>
                        </div>

                        {/* Scanner Area */}
                        <div className="mb-4">
                            {scanStatus === 'idle' && (
                                <button 
                                    onClick={startScanner} 
                                    className="w-full py-4 rounded-xl font-bold shadow-lg transition flex items-center justify-center gap-3 bg-gray-900 text-white hover:bg-black">
                                    <i className="fa fa-qrcode text-xl"></i>
                                    <span>{t.scanBtn}</span>
                                </button>
                            )}
                            
                            {scanStatus === 'scanning' && (
                                <div className="rounded-xl overflow-hidden bg-black">
                                    <div id="reader" width="100%"></div>
                                </div>
                            )}

                            {scanStatus === 'success' && (
                                <div className="w-full py-4 rounded-xl font-bold shadow-lg flex items-center justify-center gap-3 bg-green-600 text-white">
                                    <i className="fa fa-check-circle text-xl"></i>
                                    <span>{t.verified}</span>
                                </div>
                            )}
                        </div>

                        <div className="flex items-center justify-center my-4">
                            <div className="flex-grow h-px bg-gray-200"></div>
                            <span className="px-3 text-xs font-bold text-gray-400 uppercase">{t.or}</span>
                            <div className="flex-grow h-px bg-gray-200"></div>
                        </div>

                        <div className="bg-white border rounded-xl p-4 mb-4">
                            <h3 className="font-bold text-gray-700 mb-2 text-sm">{t.enterPin}</h3>
                            <div className="flex gap-2">
                                <input 
                                    type="text" 
                                    className="input-field py-2 text-center tracking-widest font-bold uppercase" 
                                    placeholder="PIN"
                                    maxLength="4"
                                    value={inputCode}
                                    onChange={e => { setInputCode(e.target.value); setCodeError(false); }}
                                />
                                <button onClick={handleCodeVerify} className="bg-gray-100 text-gray-800 border border-gray-300 px-4 rounded-lg font-bold hover:bg-gray-200 transition">
                                    {t.go}
                                </button>
                            </div>
                            {codeError && <div className="text-red-500 text-xs mt-2 font-bold"><i className="fa fa-times-circle"></i> {t.invalidPin}</div>}
                        </div>

                        <div className="border-t pt-4 text-center">
                            <button onClick={onDebugTeleport} className="text-xs text-gray-400 hover:text-gray-600">ðŸ”§ {t.bypass}</button>
                        </div>
                    </div>
                </div>
            );
        };

        const QuizScreen = ({ location, question, onBack, onComplete, onAnswerLog, lang }) => {
            const [view, setView] = useState('question'); 
            const [feedback, setFeedback] = useState(null); 
            const [userAnswer, setUserAnswer] = useState(null);
            const t = TRANSLATIONS[lang];
            
            const stories = getStories(location.id, lang);

            const handleAnswer = (opt) => {
                if (userAnswer) return;
                setUserAnswer(opt);
                const isCorrect = opt === question.answer;
                setFeedback(isCorrect ? 'correct' : 'wrong');
                onAnswerLog(location.id);
                
                if (isCorrect) {
                    setTimeout(() => setView('stories'), 1500);
                }
            };

            if (view === 'question') {
                return (
                    <div className="fixed inset-0 z-50 bg-white flex flex-col h-screen">
                        <div className="p-4 border-b flex items-center justify-between">
                            <button onClick={onBack} className="text-gray-500 p-2"><i className="fa fa-times"></i></button>
                            <div className="font-bold text-gray-800">{t.challenge}</div>
                            <div className="w-8"></div>
                        </div>

                        <div className="flex-grow overflow-y-auto p-6 max-w-2xl mx-auto w-full">
                            <h3 className="text-xl md:text-2xl font-bold text-gray-900 mb-8 leading-relaxed">
                                {question.text}
                            </h3>

                            <div className="space-y-3">
                                {question.options.map((opt, i) => (
                                    <button key={i} onClick={() => handleAnswer(opt)} 
                                        className={`w-full p-4 text-left border-2 rounded-xl transition font-medium
                                        ${userAnswer === opt 
                                            ? (opt === question.answer ? 'bg-green-100 border-green-500 text-green-700' : 'bg-red-100 border-red-500 text-red-700')
                                            : 'border-gray-100 hover:border-[#A6192E] hover:bg-red-50'
                                        }`}>
                                        {opt}
                                    </button>
                                ))}
                            </div>
                            
                            {feedback === 'wrong' && (
                                <div className="mt-6 p-4 bg-red-50 text-red-600 rounded-xl text-center font-bold fade-in">
                                    {t.incorrect}
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            return (
                <div className="fixed inset-0 z-50 bg-white flex flex-col h-screen fade-in">
                    <div className="bg-[#A6192E] text-white p-8 text-center rounded-b-3xl shadow-lg relative">
                        <div className="text-4xl mb-2">ðŸŽ‰</div>
                        <h2 className="text-2xl font-bold">{t.memories}</h2>
                        <p className="opacity-90 text-sm">{t.readStories}</p>
                    </div>

                    <div className="flex-grow overflow-y-auto p-6 max-w-2xl mx-auto w-full -mt-4">
                        {stories.map((story, i) => (
                            <div key={i} className="bg-white p-6 rounded-xl shadow-md border border-gray-100 mb-4 slide-up" style={{animationDelay: `${i*0.1}s`}}>
                                <p className="text-gray-600 italic mb-3">"{story.text}"</p>
                                <div className="text-right">
                                    <span className="text-xs font-bold text-[#A6192E] bg-red-50 px-2 py-1 rounded">
                                        <i className="fa fa-user mr-1"></i> {story.user}
                                    </span>
                                </div>
                            </div>
                        ))}
                    </div>

                    <div className="p-4 bg-white border-t safe-area-bottom">
                        <button onClick={() => onComplete(true)} className="w-full bg-gray-900 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-black max-w-md mx-auto block">
                            {t.collectClose}
                        </button>
                    </div>
                </div>
            );
        };

        const AdminDashboard = ({ onReview, onBack, stats, allUsers, lang }) => {
            const t = TRANSLATIONS[lang];
            const [tab, setTab] = useState('qr'); // Default to QR tab to show generator

            return (
                <div className="fixed inset-0 z-50 bg-gray-100 flex flex-col h-screen overflow-y-auto">
                    <div className="bg-white p-4 shadow-sm flex items-center justify-between sticky top-0 z-10">
                        <div className="flex items-center">
                            <button onClick={onBack} className="text-gray-500 mr-4"><i className="fa fa-arrow-left"></i></button>
                            <h2 className="font-bold text-xl">{t.adminPortal}</h2>
                        </div>
                        <div className="flex bg-gray-100 rounded p-1">
                            <button onClick={()=>setTab('qr')} className={`px-4 py-1 rounded text-sm font-bold ${tab==='qr' ? 'bg-white shadow text-[#A6192E]' : 'text-gray-500'}`}>{t.qrTab}</button>
                            <button onClick={()=>setTab('stats')} className={`px-4 py-1 rounded text-sm font-bold ${tab==='stats' ? 'bg-white shadow text-[#A6192E]' : 'text-gray-500'}`}>Stats</button>
                        </div>
                    </div>
                    
                    <div className="p-4 max-w-4xl mx-auto w-full space-y-4">
                        {tab === 'qr' && (
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 fade-in">
                                {LOCATIONS.map(loc => (
                                    <div key={loc.id} className="bg-white p-6 rounded-xl shadow-sm text-center">
                                        <h3 className="font-bold text-lg text-gray-800 mb-2">{loc.name[lang]}</h3>
                                        <div className="flex justify-center my-4">
                                            <canvas ref={(el) => {
                                                if(el) {
                                                    new QRious({
                                                        element: el,
                                                        value: `POLYU_HUNT:${loc.id}`,
                                                        size: 200
                                                    });
                                                }
                                            }}></canvas>
                                        </div>
                                        <p className="text-xs text-gray-400 font-mono">POLYU_HUNT:{loc.id}</p>
                                    </div>
                                ))}
                            </div>
                        )}

                        {tab === 'stats' && (
                            <div className="space-y-6 fade-in">
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="bg-white p-4 rounded-xl shadow-sm">
                                        <p className="text-xs text-gray-500 uppercase">{t.totalUsers}</p>
                                        <p className="text-2xl font-bold text-[#A6192E]">{allUsers.length}</p>
                                    </div>
                                    <div className="bg-white p-4 rounded-xl shadow-sm">
                                        <p className="text-xs text-gray-500 uppercase">{t.totalStamps}</p>
                                        <p className="text-2xl font-bold text-[#A6192E]">
                                            {Object.values(stats.userAnswers).reduce((a,b)=>a+b, 0)}
                                        </p>
                                    </div>
                                </div>

                                <div className="bg-white rounded-xl shadow-sm overflow-hidden">
                                    <div className="p-4 border-b bg-gray-50 font-bold text-gray-700">{t.userActivity}</div>
                                    <table className="w-full text-sm text-left">
                                        <thead className="text-xs text-gray-500 uppercase bg-gray-50 border-b">
                                            <tr>
                                                <th className="px-6 py-3">{t.fullName}</th>
                                                <th className="px-6 py-3">{t.role}</th>
                                                <th className="px-6 py-3">{t.stamps}</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {allUsers.map((u, i) => (
                                                <tr key={i} className="bg-white border-b hover:bg-gray-50">
                                                    <td className="px-6 py-4 font-medium text-gray-900">{u.name}</td>
                                                    <td className="px-6 py-4">{u.role}</td>
                                                    <td className="px-6 py-4 font-bold text-[#A6192E]">{stats.userAnswers[u.email] || 0}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('register');
            const [lang, setLang] = useState('en'); // 'en', 'tc', 'sc'
            const [activeLoc, setActiveLoc] = useState(null);
            const [modalOpen, setModalOpen] = useState(false);
            const [notification, setNotification] = useState(null); 
            const [stampBookOpen, setStampBookOpen] = useState(false);
            const [overseasUnlocked, setOverseasUnlocked] = useState(false);
            const [giftClaimOpen, setGiftClaimOpen] = useState(false); // Gift modal state
            
            // Firebase State
            const [allUsers, setAllUsers] = useState([]);
            const [stats, setStats] = useState({ userAnswers: {}, questionAnswers: {} });
            const [cleared, setCleared] = useState([]);

            const t = TRANSLATIONS[lang];

            // 1. Initial Auth
            useEffect(() => {
                const initAuth = async () => {
                    const { auth, signInAnonymously } = window.FB;
                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("Firebase Auth failed, falling back to offline mode", error);
                        // Optionally show a toast
                    }
                };
                initAuth();

                const { auth, onAuthStateChanged, db, collection, doc, onSnapshot, appId } = window.FB;
                const unsubscribe = onAuthStateChanged(auth, (authUser) => {
                    if (authUser) {
                        // 2. Listen to user profile
                        const userRef = doc(db, 'artifacts', appId, 'participants', authUser.uid);
                        onSnapshot(userRef, (docSnap) => {
                            if (docSnap.exists()) {
                                const userData = docSnap.data();
                                setUser({ ...userData, uid: authUser.uid });
                                setCleared(userData.clearedLocations || []);
                                setView('map');
                            } else {
                                // No profile yet, user stays on register screen
                                setUser(null); 
                            }
                        });
                    }
                });
                return () => unsubscribe();
            }, []);

            // 3. Listen for Admin Stats (if user is admin)
            useEffect(() => {
                if (user?.role === 'admin') {
                    const { db, collection, onSnapshot, appId } = window.FB;
                    // Guard if db not initialized
                    if (!db) return;

                    const q = collection(db, 'artifacts', appId, 'participants');
                    const unsubscribe = onSnapshot(q, (snapshot) => {
                        const users = [];
                        const userAnswers = {};
                        
                        snapshot.forEach(doc => {
                            const u = doc.data();
                            users.push(u);
                            userAnswers[u.email] = (u.clearedLocations || []).length;
                        });
                        setAllUsers(users);
                        setStats({ userAnswers, questionAnswers: {} });
                    });
                    return () => unsubscribe();
                }
            }, [user?.role]);

            const showNotify = (title, message, type = 'info', customIcon = null) => {
                setNotification({ title, message, type, customIcon });
            };

            const handleAnswerLog = (qId) => {
                // In real app, increment question stats in DB
            };

            const handleQuizComplete = async (success) => {
                if (success) {
                    const { db, doc, updateDoc, arrayUnion, appId } = window.FB;
                    const { auth } = window.FB;
                    
                    if (cleared.includes(activeLoc.id)) {
                        showNotify(t.alreadyClearedTitle, t.alreadyClearedMsg, "info", activeLoc.icon);
                    } else {
                        // Optimistic update
                        const newCleared = [...cleared, activeLoc.id];
                        setCleared(newCleared);

                        // DB Update if online
                        if (auth && auth.currentUser && db) {
                            const userRef = doc(db, 'artifacts', appId, 'participants', auth.currentUser.uid);
                            await updateDoc(userRef, {
                                clearedLocations: arrayUnion(activeLoc.id)
                            });
                        }
                        
                        // Check for Grand Success (10 Locations)
                        if (newCleared.length === 10) {
                            if (user.version === 'overseas') {
                                setGiftClaimOpen(true);
                            } else {
                                showNotify(t.grandSuccessTitle, t.grandSuccessMsg, "success", "fa-crown");
                            }
                        } else {
                            showNotify(
                                t.stampCollectedTitle, 
                                t.stampCollectedMsg + ` (${activeLoc.name[lang]})`, 
                                "success", 
                                activeLoc.icon
                            );
                        }
                    }
                }
                setActiveLoc(null);
                setView('map');
            };

            const handleGiftSubmit = async (giftData) => {
                const { db, doc, updateDoc, appId, auth } = window.FB;
                if (auth && auth.currentUser && db) {
                    const userRef = doc(db, 'artifacts', appId, 'participants', auth.currentUser.uid);
                    await updateDoc(userRef, {
                        giftRequest: giftData
                    });
                }
            };

            const handleSelectLocation = (loc, isLocked) => {
                // Check lock status
                if (isLocked) {
                    showNotify(t.lockedTitle, t.lockedMsg, 'error');
                    return;
                }

                if (user.version === 'overseas') {
                    if (!overseasUnlocked) return; 
                    setActiveLoc(loc);
                    setView('quiz'); 
                } else {
                    setActiveLoc(loc);
                    setModalOpen(true);
                }
            };

            const handleRegister = async (formData) => {
                const { db, doc, setDoc, auth, appId } = window.FB;
                
                // Check if auth is valid
                if (!auth || !auth.currentUser) {
                    console.warn("Offline Mode: Skipping Firestore write");
                    const offlineUser = {
                        ...formData,
                        uid: 'offline-user',
                        clearedLocations: [],
                        role: formData.name.toLowerCase() === 'admin' ? 'admin' : formData.role || 'student'
                    };
                    setUser(offlineUser);
                    if (offlineUser.role === 'admin') {
                         // Mock admin data
                         setAllUsers([{name: 'Demo User', role: 'student', email: 'demo@test.com'}]);
                         setStats({ userAnswers: {'demo@test.com': 5}, questionAnswers: {} });
                    }
                    setView('map');
                    return;
                }

                const uid = auth.currentUser.uid;
                
                const newUser = {
                    ...formData,
                    uid,
                    clearedLocations: [],
                    joinedAt: new Date().toISOString()
                };

                await setDoc(doc(db, 'artifacts', appId, 'participants', uid), newUser);
                // The onSnapshot in useEffect will pick this up and set User state
            };

            const handleAdminLogin = async () => {
                const { db, doc, setDoc, auth, appId } = window.FB;
                
                if (!auth || !auth.currentUser) {
                    // Offline Admin
                    setUser({ name: 'Administrator', email: 'admin@system', role: 'admin', clearedLocations: [] });
                    setAllUsers([{name: 'Demo User', role: 'student', email: 'demo@test.com'}]);
                    setStats({ userAnswers: {'demo@test.com': 5}, questionAnswers: {} });
                    setView('map');
                    return;
                }

                const uid = auth.currentUser.uid;
                
                // Set admin profile
                await setDoc(doc(db, 'artifacts', appId, 'participants', uid), {
                    name: 'Administrator',
                    email: 'admin@system',
                    role: 'admin',
                    clearedLocations: []
                });
            };

            useEffect(() => {
                const style = document.createElement('style');
                style.innerHTML = `
                    .input-field { width: 100%; padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 0.75rem; outline: none; transition: all 0.2s; }
                    .input-field:focus { border-color: #A6192E; ring: 2px solid #A6192E; }
                    .label { display: block; font-size: 0.75rem; font-weight: 700; color: #374151; margin-bottom: 0.25rem; }
                `;
                document.head.appendChild(style);
            }, []);

            if(!user) return <Register onRegister={handleRegister} onAdminLogin={handleAdminLogin} lang={lang} setLang={setLang} />;

            return (
                <div className="text-gray-800">
                    {/* Notification Overlay */}
                    {notification && (
                        <NotificationModal 
                            title={notification.title} 
                            message={notification.message} 
                            type={notification.type} 
                            customIcon={notification.customIcon}
                            onClose={() => setNotification(null)} 
                            lang={lang}
                        />
                    )}

                    {/* Stamp Book Overlay */}
                    {stampBookOpen && (
                        <StampBook 
                            locations={LOCATIONS} 
                            clearedLocations={cleared} 
                            onClose={() => setStampBookOpen(false)} 
                            lang={lang}
                        />
                    )}

                    {/* Gift Claim Overlay (Overseas) */}
                    {giftClaimOpen && (
                        <GiftClaimModal 
                            user={user} 
                            onClose={() => setGiftClaimOpen(false)} 
                            onSubmit={handleGiftSubmit}
                            lang={lang} 
                        />
                    )}

                    {/* Overseas Activation Overlay */}
                    {view === 'map' && user.version === 'overseas' && !overseasUnlocked && (
                        <OverseasUnlockModal onUnlock={() => setOverseasUnlocked(true)} lang={lang} />
                    )}

                    {view === 'map' && (
                        <>
                            <MapScreen 
                                user={user} locations={LOCATIONS} clearedLocations={cleared} 
                                stamps={cleared.length}
                                onOpenStampBook={() => setStampBookOpen(true)}
                                onSelectLocation={handleSelectLocation}
                                onOpenAdmin={() => setView('admin')}
                                onSimulateTime={() => {}}
                                lang={lang}
                                setLang={setLang}
                            />
                            {modalOpen && activeLoc && (
                                <LocationModal 
                                    location={activeLoc} 
                                    onClose={() => setModalOpen(false)}
                                    onStartQuiz={() => { setModalOpen(false); setView('quiz'); }}
                                    onDebugTeleport={() => { setModalOpen(false); setView('quiz'); }} 
                                    lang={lang}
                                />
                            )}
                        </>
                    )}

                    {view === 'quiz' && activeLoc && (
                        <QuizScreen 
                            location={activeLoc} 
                            question={getQuestion(activeLoc.id, lang)}
                            onBack={() => setView('map')}
                            onComplete={handleQuizComplete}
                            onAnswerLog={handleAnswerLog}
                            lang={lang}
                        />
                    )}

                    {view === 'admin' && (
                        <AdminDashboard 
                            onReview={()=>{}}
                            onBack={() => setView('map')}
                            stats={stats}
                            allUsers={allUsers}
                            lang={lang}
                        />
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>